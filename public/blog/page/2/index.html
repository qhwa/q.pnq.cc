
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>qhwa's blog</title>
	<meta name="author" content="qhwa">

	
	<meta name="description" content="最近 @季子乌 的 花瓣账号 突然被封，苦心采集的很多图片一下子全部看不到了！ 后来虽然联系客服重新开通了账号，但还是心有余悸，觉得还是 pinterest 靠谱一些，准备把图片全部迁移到 pinterest 上。由于图片数量比较多，我就用 ruby 写了一个工具，将花瓣上的图片下载下来。（不过 &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="qhwa's blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">qhwa's blog</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:q.pnq.cc">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
		<a class="github" href="https://github.com/qhwa" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:q.pnq.cc">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/11/16/a-little-project-for-download-huaban-pins/">
		
			如何开发 Ruby 命令行工具</a>
	</h2>
	<div class="entry-content">
		<p>最近 @季子乌 的 <a href="http://huaban.com/pigeonzhu">花瓣账号</a> 突然被封，苦心采集的很多图片一下子全部看不到了！</p>

<p>后来虽然联系客服重新开通了账号，但还是心有余悸，觉得还是 <a href="http://www.pinterest.com/">pinterest</a> 靠谱一些，准备把图片全部迁移到 pinterest 上。由于图片数量比较多，我就用 ruby 写了一个工具，将花瓣上的图片下载下来。（不过 pinterest 不能批量上传，这些图片也只是备份到本地，这是后话了）</p>

<p>这个项目已开源，地址是：
<a href="https://github.com/qhwa/huaban_exporter">https://github.com/qhwa/huaban_exporter</a></p>

<p>这个工具下载后，可以用执行 <code>huaban</code> 命令</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>huaban <span class="nb">export </span>boards --of qhwa
</span></code></pre></td></tr></table></div></figure>


<p>执行效果：</p>

<p><img src="https://xiaotuhe.com/uploads/share/file/58904c1c21892b12963cca37291e6547.gif" alt="preview" /></p>

<p>我喜欢用命令行工作，之前做的几个 gem（<a href="https://github.com/qhwa/lfd">lfd</a>, <a href="https://github.com/qhwa/fdlint">fdlint</a>）也都提供了命令行。这次就趁这个项目总结了一下怎样用 ruby 开发友好的命令行工具。</p>

<h3>I. 初期怎样提高开发效率？</h3>

<p>在写了基础的一些逻辑 model 后，我写个简单的 <a href="https://github.com/qhwa/huaban_exporter/blob/69b16009357a87f2e6e645801694a16b65803a41/Rakefile">rake 文件</a>，初期用 rake 来作为入口，边开发边测试。</p>

<p>一开始我只建了这样的一个 rake 任务，来调试获取画板列表功能：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rake boards         <span class="c"># 列出一个用户的所有画板 (user=用户名 rake boards)</span>
</span></code></pre></td></tr></table></div></figure>


<p>后来随着功能不断完成，逐渐增加了几个新的任务，最后是完整的任务：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rake boards         <span class="c"># 列出一个用户的所有画板 (user=用户名 rake boards)</span>
</span><span class='line'>rake export_board   <span class="c"># 导出一个画板的所有图片到本地 (board_id=画板id  rake export_board)</span>
</span><span class='line'>rake export_boards  <span class="c"># 导出用户所有的画板图片到本地 (user=用户名 rake export_boards)</span>
</span><span class='line'>rake pins           <span class="c"># 列出一个画板所有的采集 (board_id=画板id rake pins)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>II. 项目后期功能稳定后，怎么做命令行入口</h3>

<p>rakefile 很适合自己用，但是要分发别人用，用 rakefile 就不方便了。做成带命令行脚本的 gem 更加方便。</p>

<ul>
<li>把你的脚本放到 <code>bin</code> 目录下</li>
<li>加上执行权限(<code>chmod a+x</code>)</li>
<li>加上 <a href="http://zh.wikipedia.org/zh-cn/Shebang">shebang</a>, 比如 <code>#!/usr/bin/env ruby</code></li>
</ul>


<blockquote><p>这一步我以前是用下面提到的 gli 来自动进行，但后来改成手动做了。因为 gli 生成了一些额外的文件，和 bundle 有点冲突。</p></blockquote>

<h3>III. 怎样让命令变得友好?</h3>

<p>有个超棒的 gem 叫做 <a href="https://github.com/davetron5000/gli">gli</a>，帮你很容易实现出类似 git 这样风格的脚本</p>

<h3>IV. 项目完成后，怎么用做成一个 gem，分享给别人?</h3>

<p><a href="http://bundler.io/">bundler</a> 提供了生成 gem 的功能</p>

<ol>
<li><code>bundle gem &lt;name&gt;</code> 生成目录结构</li>
<li>修改 gemspec</li>
<li><code>rake install</code> 先在本地安装这个 gem 进行测试</li>
<li><code>rake build</code>   以最新的文件重新打包成 gem</li>
<li><code>gem push pkg/&lt;版本&gt;.gem</code> 将gem上传到 <a href="https://rubygems.org">https://rubygems.org</a></li>
</ol>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-11-16T15:54:01+08:00" pubdate data-updated="true">Nov 16<span>th</span>, 2014</time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/10/13/ssl-notes-with-rails/">
		
			SSL Notes With Ruby on Rails</a>
	</h2>
	<div class="entry-content">
		<p>上周我给<a href="https://xiaotuhe.com">小兔盒</a>加上了https，比想象中容易许多。记录一下</p>

<h3>免费的CA:</h3>

<p>之前一直以为 CA 是需要每年付一笔不菲的费用的，但其实也有免费的，例如：</p>

<ul>
<li><a href="https://buy.wosign.com/free/">https://buy.wosign.com/free/</a> (推荐)</li>
<li><a href="https://www.startssl.com/">https://www.startssl.com/</a></li>
</ul>


<p>按照网站指示，可以获得由其颁发的证书 有两个文件(certification &amp; key) 是后面工作的基础。</p>

<h3>在开发环境中使用 https (无需nginx)</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>thin start --ssl --ssl-key-file YOUR_SSL_KEY_FILE --ssl-cert-file YOUR_CERT_FILE
</span></code></pre></td></tr></table></div></figure>


<h3>一些 tips</h3>

<h4>url helpers</h4>

<p>不管当前 request 是 https 还是 http，rails 的 url_helper 都使用 http</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># file: config/routes:</span>
</span><span class='line'><span class="n">root</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;home#index&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># in views or helpers:</span>
</span><span class='line'><span class="n">root_url</span>                    <span class="c1">#=&gt; http://YOUR_SITE/</span>
</span><span class='line'><span class="n">root_url</span> <span class="ss">protocol</span><span class="p">:</span> <span class="s1">&#39;https&#39;</span>  <span class="c1">#=&gt; https://YOUR_SITE/</span>
</span></code></pre></td></tr></table></div></figure>


<h4>使用 protocol 无关的 assets 地址</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># file: config/environments/production.rb</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">action_controller</span><span class="o">.</span><span class="n">asset_host</span> <span class="o">=</span> <span class="s1">&#39;//YOUR-CDN.com&#39;</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>用工具检查</h4>

<p>有很多工具可以检查 https 部署情况，例如这个：
<a href="https://www.sslshopper.com/ssl-checker.html">https://www.sslshopper.com/ssl-checker.html</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-10-13T15:54:01+08:00" pubdate data-updated="true">Oct 13<span>th</span>, 2014</time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/04/08/shi-tan-cun-you-ji/">
		
			石潭村游记</a>
	</h2>
	<div class="entry-content">
		<p><img src="http://pnqcc.qiniudn.com/shitancun2674856703781518773.jpg" alt="石潭村" /></p>

<p>石潭村在安徽省黄山市徽州区歙县霞坑镇，距离黄山市50多公里，离杭州余杭150公里多点。我们在杭州，所以过去很近，非常适合清明小长假自驾游。从杭州往西，一路有天目山、青山湖这样的景区，即便是在高速公路上，也能看到路边的小风景。</p>

<p>杭徽高速西行大约120km，之后是省道。经过一段蜿蜒刺激的盘山公路，又穿过几个热闹的小镇子，就来到了车子能开到的尽头——石潭村。啰嗦几句，实际上还能往前开，只是政府封了路，里面的路外地车进不去，只能乘坐当地的小商务车，一辆车可以坐八个人。网上也有老的攻略说石潭村里面还有十几个村子，进去需要徒步。其实我们发现已经修了不少水泥路进去，车子可以一直开到5公里深的大龙湾。一路依山傍水，满目都是油菜花，黑砖白墙的村落点缀其间，风景很美。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun2162572246168650691.jpg" alt="路边" /></p>

<p>我们是当天下午到的石潭村，在村口打尖吃饭，人还挺少的。暗自庆幸来对了地方，是个清净的地方。吃完饭再往前走了1公里路，正式进了村子，才发现实际情况稍微糟糕了一点。人虽然没有比肩继踵，但是已经把小村子挤得满满的了，很困难地找了车位，然后随便选了一家名字看上去比较正规的旅店住下，放了行李。</p>

<p>这家旅店的名字有好几部分组成，我们只记得第一部分“游侠客”，后面那部分所有人都没记住，因为看到“游侠客”三个字，有人就兴奋地说认识游侠客的创始人，我们就决定入住这家亲切的旅店了。</p>

<p>有了地方住，心里就踏实了。放下行李，我们一行人就兴致勃勃地出发，往村里头扑去。</p>

<h2>石潭村</h2>

<p>村子依山傍水而建。山并不高，一条小溪从山间穿过，将石潭村一分为二。溪水不算多，但是很清澈。河滩上有许多青色的鹅卵石。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun6599324865005478015.jpg" alt="玩水" /></p>

<p>我们在小溪边玩了一会，然后就开始随便行走。</p>

<p>村边菜地里面油菜花还开着一些，但是也有许多已经谢了，结了果实。还有葱，一些蚕豆，长得都很粗壮。村子里面很安静。房子都很老，但历史并不长。清一色的白墙，绘了深色的花边，古色古香。有几间木结构的老屋子，看上去很精致。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun1505328175549109622.jpg" alt="村子" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun2670916054107569546.jpg" alt="村子" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun4926093567513430064.jpg" alt="村子" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun4884998220913673644.jpg" alt="村子" /></p>

<p>走着走着，就出了村子，来到了后山。看上去有路往里面走，据说是到另外的村子去的。这时候太阳已经快下山了，我们就决定不继续往前了。但是往回走又心有不甘，才没出来多久呢！边上的小山上，菜地里面中了很多油菜花，好像可以上去的样子，可是又不见有路。这时鸽子mm 咻咻地爬了上去，大家也跟着，顺着隐隐约约的小坎，爬了上去。</p>

<p>上去之后，穿过齐头高的油菜田，来到另一边山头，美景就这么突然映入眼帘。山下的村子，小溪，对面的林子、夕阳，和清新的空气一起，像画一样。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun3027263374623346861.jpg" alt="山坡" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun6608181431166740222.jpg" alt="夕阳" /></p>

<p>放下野餐毯，大家坐在一起，吃吃喝喝，好不快活！</p>

<p>慢慢地太阳从对面的山头下去了。我们也下山，继续沿着小溪散步。然后就回到旅店稍作休息，便开始找吃晚饭的地方。</p>

<p>晚饭在另外一家本地的食宿一体的旅店吃的。菜很好吃，加上大家有点累，都觉得很美味。回到杭州后鸽子还认真地在大众点评上给了4星好评，这是后话了。</p>

<p>吃完饭已经不早，大家稍微讨论了一下第二天的行程，小朋友不喜欢坐船，所以坐船的方案就被否定了。但去哪里还是没什么定论。累了一天，大家纷纷洗澡睡了。</p>

<h2>大龙湾</h2>

<p>天刚蒙蒙亮，村子就已经苏醒了。出门务农的人，开张的早餐店，准备上山的摄友……外面逐渐嘈杂起来。</p>

<p>我6点时候醒了，躺在床上看了一下地图，觉得可以沿着小溪往下游走。看到小溪在一个叫做“大龙湾”的地方拐了大弯，有山有水有桥，觉得可以去看看。</p>

<p>其他同伴们还在睡觉中，我决定独自起来看看。</p>

<p>吃过白粥配咸菜的早餐，买了根刚炸出来的油条，在村外随便散步起来了。</p>

<p>早晨的景色果然更美。山中雾气缭绕，空气有点清凉，提神。远处的树林是一层层的，像水彩画一般。透过片片的油菜花，此时的村子最像水墨画了。</p>

<p>早上出门没有带相机，只有一个效果很差、不能自动对焦的手机。。。你们勉强感受一下好了。。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun6608410129585315688.jpg" alt="早晨" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun6608212217492318021.jpg" alt="早晨" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun2849652664319389629.jpg" alt="早晨" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun4874302171798598062.jpg" alt="早晨" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun147211412920378673.jpg" alt="早晨" /></p>

<p>信步所至，都是美景。去哪应该都不错。</p>

<p>散步回来，大家已经陆续起床了。然后一起退房、出门，吃早饭，散步。简单商量了一下，就拦了一辆车往大龙湾去了。</p>

<p>沿途都是都是油菜花、小桥流水人家，大家都啧啧赞叹。</p>

<p>路上车、人都很少。开车的师傅说，我们是他见过的第一批去大龙湾的游客，上车的时候，他还以为我们是家在那边的呢！</p>

<p>大约10分钟不到，车子就飞驰到了目的地。</p>

<p>下车的地方，是村子外的桥头。清澈的山泉水沿着村民搭的竹筒子流在路上，又流进小溪。桥下的溪水很清，很多小鱼在不停嬉戏。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun3020789450159004124.jpg" alt="大龙湾" /></p>

<p>穿过桥就到了村子里面。</p>

<p>村子里静悄悄的，偶尔才看到骑自行车的小朋友从我们身边路过。后面还跟着一只小黄狗，好奇地嗅嗅我们，然后迅速追向主人了。</p>

<p>村里人少，但是很热情。我们在一位大爷家门口的长石板凳上坐下休息，和大爷聊天。</p>

<p>吃了点零食，稍微填了一点肚子。然后继续探索。</p>

<p>水边有一颗上了年纪的樟树，落下的叶子盖满了竹林间的小路。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun2986449503000247180.jpg" alt="樟树竹林" /></p>

<p>中饭本来想在水边烧烤的，但是走的时候没有带吃的东西，于是问一位采茶归来的老奶奶买了一些粽子、年糕，准备烧烤。不过老奶奶听说我们要生火，很是担心安全。。最后我们在老奶奶家借了灶，生火做饭。菜都是问老奶奶买的。</p>

<p>人们开始大秀厨艺。。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun1145040205359656732.jpg" alt="做中饭" /></p>

<p>吃了一顿饱饱的中饭，时间也是下午两点了，刚好适合回杭州。打电话叫上午送我们过来的师傅来接我们回去，不过他有事，另外找了一个师傅来接我们。</p>

<p>这是我们在等车：</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun3024448624856241351.jpg" alt="等车" /></p>

<p>回到石潭村，我们就心满意足地开车回杭州啦！</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-04-08T20:58:38+08:00" pubdate data-updated="true">Apr 8<span>th</span>, 2014</time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/18/chinse-number-gem/">
		
			Chinese_number: 一个解析汉字数字的 ~rubygem</a>
	</h2>
	<div class="entry-content">
		<p><a href="http://ruby-china.org">ruby-china</a> 上有人问到<a href="http://ruby-china.org/topics/17913">怎么优雅地解析汉字数字</a>，比如 <code>二十五</code> 解析成 <code>25</code> 。我第一反应是应该查一下有没有这样的 gem，因为是一个很普遍的需求，说不定已经有人实现了呢！</p>

<p>不过很可惜，不知道是不是我没有查到，还是真的没有，总之没有找到。所以我就写了一个这样的 gem &mdash; <strong><a href="https://github.com/qhwa/chinese_number">chinese_number</a></strong></p>

<p>用法很简单：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;chinese_number&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">ChineseNumber</span><span class="o">.</span><span class="n">trans</span> <span class="s1">&#39;今天二十万&#39;</span>
</span><span class='line'><span class="c1">#=&gt; &quot;今天200000&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="no">ChineseNumber</span><span class="o">.</span><span class="n">find</span> <span class="s2">&quot;一年有十二个月三百六十五天&quot;</span>
</span><span class='line'><span class="c1">#=&gt; [{&quot;一&quot;=&gt;1}, {&quot;十二&quot;=&gt;12}, {&quot;三百六十五&quot;=&gt;365}]</span>
</span><span class='line'>
</span><span class='line'><span class="no">ChineseNumber</span><span class="o">.</span><span class="n">extract</span> <span class="s2">&quot;今天二十晚&quot;</span>
</span><span class='line'><span class="c1">#=&gt; [20]</span>
</span><span class='line'>
</span><span class='line'><span class="ss">ChineseNumber</span><span class="p">:</span><span class="ss">:Parser</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">parse</span> <span class="s1">&#39;二零一四&#39;</span>
</span><span class='line'><span class="c1">#=&gt; 2014</span>
</span><span class='line'>
</span><span class='line'><span class="ss">ChineseNumber</span><span class="p">:</span><span class="ss">:Parser</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">parse</span> <span class="s1">&#39;一万三千&#39;</span>
</span><span class='line'><span class="c1">#=&gt; 13000</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-18T17:45:38+08:00" pubdate data-updated="true">Mar 18<span>th</span>, 2014</time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/18/variable-scope-in-js-coffeescript-and-ruby/">
		
			《代码的未来》 阅读笔记（1）—— JavaScript/CoffeScript/ruby 局部变量处理的异同</a>
	</h2>
	<div class="entry-content">
		<blockquote><p>…… 身为 JavaScript 程序员的好友说，对 javascript 的不满之一，就是它的变量声明和作用域。 —— Mats</p></blockquote>

<h2>JavaScript</h2>

<p>js 可以通过有无<code>var</code>来选择是否创建一个新的作用域：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="s2">&quot;out&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="s2">&quot;in&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">})();</span>
</span><span class='line'>
</span><span class='line'><span class="nx">alert</span><span class="p">(</span> <span class="nx">a</span> <span class="p">);</span>
</span><span class='line'><span class="c1">// &quot;out&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">a</span> <span class="o">=</span> <span class="s2">&quot;out&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">a</span> <span class="o">=</span> <span class="s2">&quot;in&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">})();</span>
</span><span class='line'>
</span><span class='line'><span class="nx">alert</span><span class="p">(</span> <span class="nx">a</span> <span class="p">);</span>
</span><span class='line'><span class="c1">// &quot;in&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>很灵活。不幸的是，不小心漏写最外层 <code>var</code> 之后，变量有可能会变成全局变量，这是容易滋生 bug 的地方。</p>

<h2>CoffeeScript</h2>

<p>CoffeeScript 中统一去掉了<code>var</code>，全部按局部变量处理，和 js 不同的是，不再创建内层作用域了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">a = </span><span class="s">&quot;out&quot;</span>
</span><span class='line'><span class="p">(()</span> <span class="nf">-&gt;</span>
</span><span class='line'>  <span class="nv">a = </span><span class="s">&quot;in&quot;</span>
</span><span class='line'><span class="p">)()</span>
</span><span class='line'><span class="nx">alert</span><span class="p">(</span> <span class="nx">a</span> <span class="p">)</span>
</span><span class='line'><span class="o">//</span> <span class="s">&quot;in&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Ruby</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># version 1</span>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;out&quot;</span>
</span><span class='line'><span class="p">(</span><span class="nb">lambda</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;in&quot;</span>
</span><span class='line'><span class="k">end</span><span class="p">)</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">a</span>
</span><span class='line'><span class="c1">#=&gt; &quot;in&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># version 2</span>
</span><span class='line'><span class="c1"># ruby 1.9+</span>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;out&quot;</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="p">;</span> <span class="n">a</span><span class="o">|</span> <span class="c1">#&lt;= 注意这里的分号</span>
</span><span class='line'>  <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;in&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">a</span>
</span><span class='line'><span class="c1">#=&gt; &quot;out&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ruby 中默认和 CoffeeScript 一致，使用外层作用域。但多了一种“作用域声明”，允许人工制定创建一个作用域。</p>

<p>结论</p>

<table>
<thead>
<tr>
<th> 语言 </th>
<th> 同名局部变量处理策略 </th>
</tr>
</thead>
<tbody>
<tr>
<td> js  </td>
<td> 内部优先，可以通过去掉 var 向上查找</td>
</tr>
<tr>
<td> coffeescript </td>
<td> 外部</td>
</tr>
<tr>
<td> ruby </td>
<td> 外部优先，可以通过声明强制使用内部</td>
</tr>
</tbody>
</table>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-18T16:21:00+08:00" pubdate data-updated="true">Mar 18<span>th</span>, 2014</time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/07/18/programing-on-principles/">
		
			编程原则</a>
	</h2>
	<div class="entry-content">
		<ol>
<li>in/out 原则：签入的代码一定要比签出时更好</li>
<li>变量命名选用最贴切、最短的</li>
<li>只为当前的需求考虑设计</li>
<li>出现当前设计无法满足的新需求时，重构设计，使用最合理的，而不是满足需求的设计</li>
</ol>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-07-18T11:49:00+08:00" pubdate data-updated="true">Jul 18<span>th</span>, 2013</time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2012/11/30/fancy-paper-list/">
		
			折纸折叠菜单效果</a>
	</h2>
	<div class="entry-content">
		<p>这个效果原先是给团队内部的一个协作网站开发的</p>

<iframe src="http://cssdeck.com/labs/full/fancy-paper-list" width="100%" height="700" ></iframe>


<p>暂时还没有时间详细写过程，有兴趣的可以看看代码，交流一下</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-11-30T00:00:00+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2012/11/30/_grunt-1/">
		
			利用 Grunt （几乎）无痛地做前端开发 (一)</a>
	</h2>
	<div class="entry-content">
		<h2>前言</h2>

<blockquote><p>如果你想开发一个js应用，甭管多简单，都要先创建整个宇宙</p></blockquote>

<p>来看看我们的Javascript小宇宙:</p>

<ol>
<li>确定如何根据需求、功能划分模块，如何将代码分成多个文件开发，合成一个发布</li>
<li>保证上一条的同时，使用 Coffeescript、SCSS/LESS 等技术</li>
<li>保证上2条的同时，想想怎么在浏览器的刷新后一切都最新</li>
<li>保证上3条的同时，想想怎么在开发、测试、生产、预发布环境中都OK</li>
<li>保证上4条的同时，进行TDD式的开发</li>
<li>&hellip;这还是js, 我们还没有涉及到HTML</li>
</ol>


<p>Grunt 可以将创建小宇宙的工作变得轻松很多。</p>

<h2>初识 grunt</h2>

<p>以一个jQuery插件的开发为例。 开始之前，让我们先安装Grunt.</p>

<p>首先需要<a href="http://nodejs.org/">Nodejs</a>环境，这里假设你已经安装好了<a href="http://nodejs.org/">Nodejs</a>和<a href="https://npmjs.org/">NPM</a>.</p>

<p>然后安装 grunt :</p>

<pre><code>npm install grunt
</code></pre>

<blockquote><p>命令行方式更适合前端开发。这里我都用命令行来进行操作，windows用户推荐用git-shell或者powershell.</p></blockquote>

<h3>第一招：快速搭建脚手架</h3>

<p>Grunt 已经安装好了，第一步就是利用grunt快速搭建脚手架出来。所谓的脚手架，就是指包含了目录结构和初始的一些功能,测试文件的一个环境。我们来搭建一个jquery插件的脚手架：</p>

<pre><code>grunt init:jquery
</code></pre>

<p>这时grunt会问你一些问题，比如项目名称, git地址,作者等等，比如:</p>

<p><img src="http://img03.taobaocdn.com/tfscom/T1EwSRXyNhXXaCwpjX.png_620x10000.jpg" alt="initing" /></p>

<p>可以看到，grunt已经帮我们创建了一些经常出现的文件(README, LICENSE等), 单元测试也准备好了。</p>

<blockquote><p>有些问题可以<a href="https://github.com/gruntjs/grunt/blob/master/docs/task_init.md#specifying-default-prompt-answers">配置一下默认回答</a>，这样就不需要每次都重新输入了，只要敲回车就行。</p></blockquote>

<h3>第二招：TDD(测试驱动开发） 和 单元测试</h3>

<p>现在我们就可以着手写grunt-demo-1这个插件了。假设我们这个插件的目的是让页面上*.alibaba.com域名下的a链接都带上一个图标。那么可以写一些简单的qunit用例。</p>

<p>首先在<code>test/grunt-demo-1.html</code>准备好HTML用例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>...
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;qunit-fixture&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#functional-link&quot;</span><span class="nt">&gt;</span>#nogo<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://alibaba.com&quot;</span><span class="nt">&gt;</span>grunt<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://china.alibaba.com&quot;</span><span class="nt">&gt;</span>grunt<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://style.china.alibaba.com&quot;</span><span class="nt">&gt;</span>grunt<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;https://q.pnq.cc&quot;</span><span class="nt">&gt;</span>qhwa<span class="nt">&lt;/a&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span><span class='line'>....
</span></code></pre></td></tr></table></div></figure>


<p>打开上一步grunt已经帮我们生成的<code>test/grunt-demo-1_test.js</code>，写上我们自己的单元测试:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// file: test/grunt-demo_test.js</span>
</span><span class='line'><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;jQuery#ali-link&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">elems</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#qunit-fixture&#39;</span><span class="p">).</span><span class="nx">children</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;is chainable&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">strictEqual</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">elems</span><span class="p">.</span><span class="nx">alilink</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nx">elems</span><span class="p">,</span> <span class="s1">&#39;should be chaninable&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;can select&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">equal</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;a:alilink&#39;</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#qunit-fixture&#39;</span><span class="p">)).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;should select links with alibaba domain&#39;</span>
</span><span class='line'>  <span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;add icon to alibaba links&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">elems</span><span class="p">.</span><span class="nx">alilink</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">elems</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span> <span class="sr">/^http:\/\/((.+)\.)?alibaba\.com/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">href</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">ok</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;ali-link&#39;</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;ali-link&#39;</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后在命令行运行一下<code>grunt qunit</code>
运行结果是这样的：</p>

<p><img src="http://img03.taobaocdn.com/tfscom/T181NBFn4fXXaCwpjX.png" alt="grunt qunit first run" /></p>

<p>各种报错，对吧？不要紧，因为我们还没有开始写代码。接下来我们的目标就是写功能代码，让这个测试通过。</p>

<p>经过一番敲击键盘，以及运行了几次<code>grunt qunit</code>，终于，激动人心时刻到来了，我们通过了所有的单元测试:</p>

<p><img src="http://img01.taobaocdn.com/tfscom/T1p5RDFn4bXXaCwpjX.png_620x10000.jpg" alt="grunt qunit pass" /></p>

<p>最终的功能js如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// file: src/grunt-demo-1.js</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">ALI_LINK_REG</span> <span class="o">=</span> <span class="sr">/^http:\/\/(.+\.)?alibaba\.com/</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Collection method.</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">alilink</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="nx">isAliLink</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">){</span>
</span><span class='line'>        <span class="nx">self</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;ali-link&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">self</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;ali-link&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Custom selector.</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">expr</span><span class="p">[</span><span class="s1">&#39;:&#39;</span><span class="p">].</span><span class="nx">alilink</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">isAliLink</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">isAliLink</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="sr">/A/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">tagName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">ALI_LINK_REG</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">href</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}(</span><span class="nx">jQuery</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>想用jasmine? 当然可以了！ 社区有 <a href="https://npmjs.org/package/grunt-jasmine-runner">grunt-jasmine-runner</a></p></blockquote>

<p>功能已经完成了，但是插件就完成了吗？非也！</p>

<p>有了单元测试，我们可以放心重构我们的代码，达到最好的可维护性。先让机器帮我们做个code review——也就是linting。</p>

<p>准备好了，就来看下一招：</p>

<h3>第三招：利用 lint 提高代码质量</h3>

<p>运行命令 <code>grunt lint</code> ，果然有报警：</p>

<p><img src="http://img03.taobaocdn.com/tfscom/T1qp8CFmXbXXaCwpjX.png_620x10000.jpg" alt="grunt lint fail" /></p>

<p>嗯，我们的正则表达式写法不太好，那就来优化一下吧！</p>

<p>又经过一阵修改，我们的代码终于在 <code>grunt lint</code> 时没有报警了，不错！</p>

<p><img src="http://img01.taobaocdn.com/tfscom/T1KuBqFhthXXaCwpjX.png_620x10000.jpg" alt="grunt lint pass" /></p>

<p>运行一下 <code>grunt qunit</code> ，看到单元测试还能通过，功能正常，不错！</p>

<h3>第四招：利用 watch 自动化</h3>

<p>上面我们在重构和优化的时候，每次修改了功能js都要运行一遍<code>grunt qunit</code>和<code>grunt lint</code>，grunt 可以帮我们做到一旦有修改，自动运行这两个命令，方便吧？</p>

<p>很简单，运行<code>grunt watch</code> 就好了。然后试一下修改 src/ 下面的 js，就不需要手动去运行qunit和lint任务了。
watch 就是这样的一个任务，监测一些文件，都有更新的时候，自动运行需要的任务。</p>

<p><img src="http://img03.taobaocdn.com/tfscom/T1bb4BFodfXXaCwpjX.png_620x10000.jpg" alt="grunt watch" /></p>

<p>grunt 还自带了一些其他的任务，比如</p>

<ul>
<li>用来压缩js和css的<code>min</code> 任务</li>
<li>用来开启一个本地http服务器的 <code>server</code> 任务</li>
<li>用来将几个文件合并成一个的 <code>concat</code> 任务</li>
</ul>


<p>这些都是我们经常使用的任务。</p>

<h2>小结</h2>

<p>本文的示例代码已经放到 <a href="https://github.com/qhwa/grunt-demo">github 上</a>。</p>

<p>这一篇我们认识了 grunt ，下一篇将会看到 grunt 这种以任务为中心的设计，带来的强大扩展性。如果上面的例子已经让你感受到了无痛开发的乐趣，那么那些社区插件保证会让你更过瘾的！敬请期待本系列的第二篇—— 让 grunt 飞起来！</p>

<h2>参考</h2>

<p><a href="https://github.com/gruntjs/grunt/blob/master/docs/task_init.md">grunt init</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-11-30T00:00:00+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2012/06/07/ruby-undecoding/">
		
			Ruby 如何“反转义”字符串</a>
	</h2>
	<div class="entry-content">
		<p>我们知道Ruby中转义字符串可以用inspect或者dump可以将字符串转义：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">t&quot;</span><span class="o">.</span><span class="n">dump</span>       <span class="c1">#=&gt; &quot;\\&quot;\\\\t\\&quot;&quot;</span>
</span><span class='line'><span class="s2">&quot;中文&quot;</span><span class="o">.</span><span class="n">dump</span>     <span class="c1">#=&gt; &quot;\\&quot;\\\\u{4e2d}\\\\u{6587}\\&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>但有时候我们想把已经被转义的字符串反转义回正常的字符串，怎么办?</p>

<p>其实方法很简单：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">unescape</span><span class="p">(</span> <span class="n">src</span> <span class="p">)</span>
</span><span class='line'>  <span class="nb">String</span><span class="o">.</span><span class="n">class_eval</span><span class="p">(</span><span class="sx">%Q(&quot;</span><span class="si">#{</span><span class="n">src</span><span class="si">}</span><span class="sx">&quot;)</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">p</span> <span class="n">unescape</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">t</span><span class="se">\\\\</span><span class="s2">n&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">t</span><span class="se">\\</span><span class="s2">n&quot;</span>  <span class="c1">#=&gt; true</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-06-07T00:00:00+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2012/06/07/ab/">
		
			使用Apache Benmark(ab) 对一个 Ruby Web 程序做性能测试</a>
	</h2>
	<div class="entry-content">
		<p>最近要在一些内部系统中嵌入<a href="https://github.com/qhwa/fdlint-host/">fdlint</a>的功能，检查HTML的语法是否正确。涉及到了系统性能测试的问题，学习了一下，在这里记录一下。</p>

<p>首先是工具的选择，apache自带的性能测试工具ab简单方便，就用他了！</p>

<h2>首页（静态页面）的测试</h2>

<p>很简单的一个命令搞定:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ab -n &lt;总数&gt; -c &lt;并发上限&gt; http://fdlint.mysite.com/
</span></code></pre></td></tr></table></div></figure>


<p>注意最后的斜杠(&ldquo;/&rdquo;)没有的话命令会报错。-__&ndash;</p>

<h2>功能页面(动态)的测试</h2>

<p>这个页面需要接受一个form表单(POST形式). 这时可以用ab的参数q指定一个POST数据的内容。</p>

<p>第一步先准备原始数据素材。我这需要提交一段HTML代码，所以找了一个HTML页面，临时下载一个也是很方便的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget http://china.alibaba.com/ -O fixture.html
</span></code></pre></td></tr></table></div></figure>


<p>第二步是把这个素材变成ab需要的方式，一是做URL编码，二是写成表单的形式。</p>

<p>我写了一个ruby脚本来做编码的工作:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;uri&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">str</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;fixture.html&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">output</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">str</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\\n|\\r/m</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;post.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
</span><span class='line'>  <span class="n">file</span> <span class="o">&lt;&lt;</span> <span class="sx">%Q(data=</span><span class="si">#{</span><span class="n">output</span><span class="si">}</span><span class="sx">&amp;type=html)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样就在当前目录下生成了一个post.txt文件，格式是</p>

<pre><code>data=&lt;编码过的HTML代码&gt;&amp;type=html
</code></pre>

<p>这是我的程序需要的数据格式，你可以根据实际需要调整。</p>

<p>然后就用ab命令了，我也写了一个shell脚本，减少反复修改执行的重复劳动：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># 测试目标url</span>
</span><span class='line'><span class="nv">server</span><span class="o">=</span>http://fdlint.mysite.com/
</span><span class='line'><span class="nv">amount</span><span class="o">=</span>5000
</span><span class='line'><span class="nv">samual</span><span class="o">=</span>500
</span><span class='line'>
</span><span class='line'>ab -q <span class="se">\\</span>
</span><span class='line'>   -n <span class="nv">$amount</span> -c <span class="nv">$samual</span> <span class="se">\\</span>
</span><span class='line'>   -p post.txt <span class="se">\\</span>
</span><span class='line'>   -T application/x-www-form-urlencoded <span class="se">\\</span>
</span><span class='line'>   <span class="nv">$server</span>
</span></code></pre></td></tr></table></div></figure>


<p>运行这个脚本，看到如下输出，表示性能测试完成:</p>

<pre><code>&gt; Benchmarking fdlint.mysite.com (be patient).....done
</code></pre>

<p>实际执行的时候遇到几个问题。首先是&#8221;-T&#8221;参数一定要有，而且一定是这个值才可以。官方文档里面只是说如果用了-p来POST, 一定设置T参数指定content-type.</p>

<h2>经验总结</h2>

<ol>
<li>如上面所说，url如果是站点根目录，一定要以斜杠(&ldquo;/&rdquo;)结尾</li>
<li>使用-p之后一定要设置-T参数</li>
<li><p>如何确定post过去之后，服务器的返回是正常的?</p>

<ol type="a">
<li>可以用ab的<code>-v</code>参数输出详细的日志，例如：<code>ab -v 4 -n 500 -c 5 $url</code></li>
<li>在服务器可以记录日志</li>
</ol>
</li>
</ol>


<h2>参考文档</h2>

<p><a href="http://httpd.apache.org/docs/2.4/programs/ab.html">官方文档链接</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-06-07T00:00:00+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>

<nav id="pagenavi">
    
        <a href="/" class="prev">Prev</a>
    
    
        <a href="/blog/page/3/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2019

    qhwa

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'qhwa';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-49131235-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>