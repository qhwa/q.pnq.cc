<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[qhwa's blog]]></title>
  <link href="http://q.pnq.cc/atom.xml" rel="self"/>
  <link href="http://q.pnq.cc/"/>
  <updated>2017-01-28T15:07:03+08:00</updated>
  <id>http://q.pnq.cc/</id>
  <author>
    <name><![CDATA[qhwa]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Elixir 源码阅读笔记: ex_doc]]></title>
    <link href="http://q.pnq.cc/blog/2017/01/28/ex-doc/"/>
    <updated>2017-01-28T10:03:00+08:00</updated>
    <id>http://q.pnq.cc/blog/2017/01/28/ex-doc</id>
    <content type="html"><![CDATA[<p>源码地址：<a href="https://github.com/elixir-lang/ex_doc">https://github.com/elixir-lang/ex_doc</a>
ex_doc 是 elixir 代码生成文档的工具。</p>

<p>生成文档的方式有很多种：</p>

<ol>
<li>利用语法解析分析源码；</li>
<li>利用语言提供的反射能力分析；</li>
</ol>


<p>Elixir 提供的反射功能非常全面，利用 Code 模块提供的一些方法，可以获得目标模块的很多信息。</p>

<p>文档也是其中一种。例如我们有这样的一个模块：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="k">defmodule</span> <span class="no">Example</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'><span class="k">  </span><span class="nv">@moduledoc</span> <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">  Example module for `ex_doc`.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">  ## Examples</span>
</span><span class='line'>
</span><span class='line'><span class="sd">  ``\`</span>
</span><span class='line'><span class="sd">  iex&gt; Example.hello</span>
</span><span class='line'><span class="sd">  :world</span>
</span><span class='line'><span class="sd">  ``\`</span>
</span><span class='line'><span class="sd">  &quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">@doc</span> <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">  hello world!</span>
</span><span class='line'><span class="sd">  &quot;&quot;&quot;</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">hello</span> <span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="ss">:world</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们可以通过 <code>Code.get_docs/2</code> 获得模块的文档。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Code</span><span class="o">.</span><span class="n">get_docs</span> <span class="no">Example</span><span class="p">,</span> <span class="ss">:all</span>
</span><span class='line'><span class="p">[</span><span class="ss">docs:</span> <span class="p">[{</span> <span class="p">{</span><span class="ss">:hello</span><span class="p">,</span> <span class="m">0</span><span class="p">},</span> <span class="m">14</span><span class="p">,</span> <span class="ss">:def</span><span class="p">,</span> <span class="p">[],</span> <span class="s2">&quot;hello world!\n&quot;</span><span class="p">}],</span>
</span><span class='line'> <span class="ss">moduledoc:</span> <span class="p">{</span><span class="m">3</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;Example module for `ex_doc`.\n\n</span><span class="err">##</span><span class="s2"> Examples\n\n```\niex&gt; Example.hello\n:world\n```\n&quot;</span><span class="p">},</span>
</span><span class='line'> <span class="ss">callback_docs:</span> <span class="p">[],</span> <span class="ss">type_docs:</span> <span class="p">[]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到，Elixir 已经在模块的信息中保存了相关的文档信息。ExDoc 接下来做的是提取出来，并进行格式转换。其中用到非常多的反射的接口，大部分都在 <code>Code</code> 模块中提供了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Daily Reading Note #1]]></title>
    <link href="http://q.pnq.cc/blog/2017/01/17/daily-reading-1/"/>
    <updated>2017-01-17T23:16:40+08:00</updated>
    <id>http://q.pnq.cc/blog/2017/01/17/daily-reading-1</id>
    <content type="html"><![CDATA[<p>这里记录了每天阅读代码记录的新知识。</p>

<h3>List.keymember?/3</h3>

<p>用来检查 Keyword List 中有没有对应的 key / value：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">List</span><span class="o">.</span><span class="n">keymember?</span><span class="p">([</span><span class="ss">a:</span> <span class="m">1</span><span class="p">,</span> <span class="ss">b:</span> <span class="m">2</span><span class="p">],</span> <span class="ss">:a</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'><span class="no">true</span>
</span><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">List</span><span class="o">.</span><span class="n">keymember?</span><span class="p">([</span><span class="ss">a:</span> <span class="m">1</span><span class="p">,</span> <span class="ss">b:</span> <span class="m">2</span><span class="p">],</span> <span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
</span><span class='line'><span class="no">true</span>
</span><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">List</span><span class="o">.</span><span class="n">keymember?</span><span class="p">([</span><span class="ss">a:</span> <span class="m">1</span><span class="p">,</span> <span class="ss">b:</span> <span class="m">2</span><span class="p">],</span> <span class="ss">:c</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'><span class="no">false</span>
</span></code></pre></td></tr></table></div></figure>


<h3>:code.where_is_file/1</h3>

<p>可以从 load_paths 中找到 beam 文件</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="ss">:code</span><span class="o">.</span><span class="n">where_is_file</span><span class="p">(</span><span class="s1">&#39;Elixir.Kernel.beam&#39;</span><span class="p">)</span>
</span><span class='line'><span class="s1">&#39;/usr/local/bin/../lib/elixir/ebin/Elixir.Kernel.beam&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Code.prepend_path/1</h3>

<p>将一个路径加入 Elixir 的 load_paths</p>

<h3>Code.eval_string/3</h3>

<p>执行一段代码，并返回结果，以及结果 binding</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Code</span><span class="o">.</span><span class="n">eval_string</span> <span class="s2">&quot;b = a + 1&quot;</span><span class="p">,</span> <span class="p">[</span><span class="ss">a:</span> <span class="m">1</span><span class="p">],</span> <span class="ss">file:</span> <span class="n">__ENV__</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="ss">line:</span> <span class="n">__ENV__</span><span class="o">.</span><span class="n">line</span>
</span><span class='line'><span class="p">{</span><span class="m">2</span><span class="p">,</span> <span class="p">[</span><span class="ss">a:</span> <span class="m">1</span><span class="p">,</span> <span class="ss">b:</span> <span class="m">2</span><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Keyword.get_values/2</h3>

<p>获取关键字列表中某个 key 对应的所有值，很适合用来获取参数</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Keyword</span><span class="o">.</span><span class="n">get_values</span> <span class="p">[</span><span class="ss">path:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">path:</span> <span class="s2">&quot;b/c&quot;</span><span class="p">],</span> <span class="ss">:path</span>
</span><span class='line'><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b/c&quot;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>:binary.last/1<code>或</code>String.last/1</h3>

<p>获取字符串的最后一个字符</p>

<h3>Kernel.struct/2</h3>

<p>适合留下 struct 合法的 key，丢弃不合法的 key</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="k">defmodule</span> <span class="no">User</span> <span class="k">do</span>
</span><span class='line'><span class="o">...&gt;</span>  <span class="n">defstruct</span> <span class="ss">name:</span> <span class="no">nil</span>
</span><span class='line'><span class="o">...&gt;</span> <span class="k">end</span>
</span><span class='line'><span class="o">...&gt;</span> <span class="n">struct</span> <span class="err">%</span><span class="no">User</span><span class="p">{</span><span class="ss">name:</span> <span class="s2">&quot;qhwa&quot;</span><span class="p">},</span> <span class="err">%</span><span class="p">{</span><span class="ss">name:</span> <span class="s2">&quot;Billy&quot;</span><span class="p">,</span> <span class="ss">age:</span> <span class="m">10</span><span class="p">}</span>
</span><span class='line'><span class="err">%</span><span class="no">User</span><span class="p">{</span><span class="ss">name:</span> <span class="s2">&quot;Billy&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Code.ensure_loaded?/1</h3>

<p>可以判断一个 Module 是否已经加载进来了</p>

<h3>Path.wildcard/1</h3>

<p>等于 Ruby 的 <code>Dir.glob</code></p>

<h3>Path.basename/2</h3>

<p>和 Ruby 一样，可以用来去掉扩展名</p>

<h3>Kernel.function_exported?/3</h3>

<p>判断一个模块是否暴露了方法名</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="n">function_exported?</span> <span class="no">Kernel</span><span class="p">,</span> <span class="ss">:struct</span><span class="p">,</span> <span class="m">2</span>
</span><span class='line'><span class="no">true</span>
</span></code></pre></td></tr></table></div></figure>


<h3><code>Code.get_docs/2</code></h3>

<p>如果编译时有 <code>--docs</code> 选项（默认是有的），可以从模块中得到文档。返回 <code>{line, text}</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Code</span><span class="o">.</span><span class="n">get_docs</span> <span class="no">Code</span><span class="p">,</span> <span class="ss">:moduledoc</span>
</span><span class='line'><span class="p">{</span><span class="m">2</span><span class="p">,</span>
</span><span class='line'> <span class="s2">&quot;Utilities for managing code compilation, code evaluation and code loading.\n\nThis module complements Erlang&#39;s [`:code` module](http://www.erlang.org/doc/man/code.html)\nto add behaviour which is specific to Elixir. Almost all of the functions in this module\nhave global side effects on the behaviour of Elixir.\n&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Enum.at/1</h3>

<h3>module.<strong>info</strong>(:compile)</h3>

<p>能获取一些编译信息</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Code</span><span class="o">.</span><span class="n">__info__</span><span class="p">(</span><span class="ss">:compile</span><span class="p">)</span>
</span><span class='line'><span class="p">[</span><span class="ss">options:</span> <span class="p">[</span><span class="ss">:debug_info</span><span class="p">],</span> <span class="ss">version:</span> <span class="s1">&#39;6.0.1&#39;</span><span class="p">,</span> <span class="ss">time:</span> <span class="p">{</span><span class="m">2017</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">33</span><span class="p">,</span> <span class="m">52</span><span class="p">},</span>
</span><span class='line'> <span class="ss">source:</span> <span class="s1">&#39;/Users/jose/OSS/elixir/lib/elixir/lib/code.ex&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Kernel.Typespec.beam_specs/1</h3>

<p>可以获取一个模块的类型信息</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Kernel</span><span class="o">.</span><span class="no">Typespec</span><span class="o">.</span><span class="n">beam_specs</span><span class="p">(</span><span class="no">Code</span><span class="p">)</span>
</span><span class='line'> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<h3>如何在管道中用 <code>||</code></h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">a</span> <span class="o">|&gt;</span> <span class="n">func</span><span class="p">()</span> <span class="o">|&gt;</span> <span class="no">Kernel</span><span class="o">.||</span><span class="p">([])</span> <span class="o">|&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">inspect</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[也谈谈月饼事件]]></title>
    <link href="http://q.pnq.cc/blog/2016/09/17/mooncake/"/>
    <updated>2016-09-17T12:50:44+08:00</updated>
    <id>http://q.pnq.cc/blog/2016/09/17/mooncake</id>
    <content type="html"><![CDATA[<p><img src="http://www.zaobao.com.sg/sites/default/files/styles/article_large_full/public/images/201609/20160914/809.jpg?itok=vyZLXFnr&amp;timestamp=1473817356" alt="mooncake" /></p>

<p>中秋前夕，阿里的月饼事件引爆了圈内网络（<a href="https://www.zhihu.com/question/50600301">事件回顾</a>）。事情从当事人双方的角度来说都有道理：</p>

<ul>
<li>程序员：只是利用技术替代人工抢，和正常点击按钮抢并没有差别。没想到服务器端有程序 bug，可以不停抢。发现问题后没有付款，赶快联系了行政要退还。</li>
<li>HR: 5个人抢了120多盒月饼，过分了。安全部门的职责就是防范「黑灰产」的，怎么能「监守自盗」！(淘宝上有阿里的中秋月饼在售卖）</li>
</ul>


<p>我相信阿里有自己的立场和原则，不会为外界质疑所动，甚至他们 4 小时的复盘结果也是毫无愧谦之意。也有人颇为赞同这种「捍卫价值观」的做法。</p>

<p>但阿里在程序员的心目中一落千丈已经是不争的事实，外界技术人员对阿里的看法更清醒了，阿里不是一家技术驱动的公司，这里没有工程师文化的土壤。甚至连内部的程序员也对事件非常失望。在我印象里，上市之后，阿里对技术「开源」的态度急转而下。阿里已经成为一个竭尽全力避免风险的公司。这无可厚非，几乎没有一家公司像阿里这样拥有巨大的成功而又充满争议。</p>

<p><img src="http://q.pnq.cc/images/toy.jpg" alt="toy" /></p>

<p>然而懂点程序的人都能看得出问题所在。</p>

<ul>
<li>假设这5个人，每人只抢了一盒月饼，从性质上来说，还是不是一样的？显然不是，因为明显可以排除拿去售卖 的可能。但从阿里的官方说辞里面，显然是一样的性质：「技术压制」造成不公平，以及利用系统漏洞获利。那这种情况，是不是也开除？</li>
<li><p>对比一下以下情况，你觉得性质上是否有差别：</p>

<ul>
<li>抢到 100 盒月饼，每盒都付款；</li>
<li>抢到 100 盒月饼，每盒都付款，然后进行高价售卖；</li>
<li>抢到 100 盒月饼，但是只买 1 盒，其余的主动退掉。</li>
</ul>
</li>
</ul>


<p>我再举一个真实的发生在我身上的案例。有一次，妹纸和她的小伙伴们想要去一个博物馆看一个很不错的展览，这个展览在她们的行业里是很火爆的，需要在博物馆的网站上抢票，虽然票是免费发放的，但是只能在一个时间后才开放。她们担心到时候人多抢不到票，于是让我帮忙看看。我试了一下，发现时间限制只是在网页前端做的，完全可以绕开。就用几条命令帮她们提前申请到票了。我没有觉得有愧于心，因为：</p>

<ul>
<li>我有机会领到更多的票，高价出售给别人，但我没有；</li>
<li>我可以炫耀给别人，让博物馆因为这个漏洞遭受损失，但我没有；</li>
</ul>


<p>可见，我是有机会成为所谓的「黑灰产」的，但我没有。<strong>如果因为我将来可能会犯错，而将我提前关起来，这个逻辑是不合理的。</strong></p>

<p>以我 7 年多阿里生涯来看，真没看出来抢月饼是不符合哪条价值观了。以未曾发生的事情（安全部成了自我黑灰产）为处理依据，臆断别人的用意；为了达到杀鸡儆猴的效果，做出令人啼笑皆非的处理。这件事情拿不出哪条条例，连价值观的说法也难以服众。还说不是处罚太重？这恐怕是本年度程序员最被误解的事情了吧？</p>

<p>从阿里离职以来，本着价值观「随时随地维护公司形象」，我从未说过阿里什么坏话，但这件事情让我太看不下去了，看不下去程序员被如此误解，如此对待。</p>

<p>只想表达一个观点：这件事情的处理是不懂程序员的阿里管理层犯下的一个错误，但会有什么影响，历史会告诉我们。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[minifying-with-webpack]]></title>
    <link href="http://q.pnq.cc/blog/2016/05/05/minifying-with-webpack/"/>
    <updated>2016-05-05T10:09:12+08:00</updated>
    <id>http://q.pnq.cc/blog/2016/05/05/minifying-with-webpack</id>
    <content type="html"><![CDATA[<p><img src="https://cdn-images-1.medium.com/max/1600/1*rsOjd1jR3eOmJNJh4Zp42g.png" alt="webpack bundling" /></p>

<p>When coding in a modern modular way with Webpack is done, it enters the deploy phrase. We minify assets to reduce the network transfer cost. While bundling is not necessary nowadays thanks to HTTP/2, minifying is still an important work, because in many cases we can reduce the size to transfer between servers and clients:</p>

<ul>
<li>unreachable codes can be removed</li>
<li>comments code can be removed</li>
<li>images can be optimised losslessly</li>
<li>variable names can be shortened in Javascript</li>
<li>HTML and SVGs can be optimised</li>
</ul>


<p>Here in <a href="http://www.helijia.com">Helijia</a>, we use webpack to build mobile apps. Here are some notes from us on minifying with <a href="https://webpack.github.io">Webpack</a>.</p>

<h2>Minifying Javascript / CSS</h2>

<p><a href="https://webpack.github.io">Webpack</a> is shipped with some builtin plugins which can do the job well.
* <a href="https://webpack.github.io/docs/list-of-plugins.html#dedupeplugin">Dedupe Plugin</a> searches for similar files and deduplicated them in the output.
* <a href="https://webpack.github.io/docs/list-of-plugins.html#uglifyjsplugin">UglyfiJS Plugin</a> uses the famous <a href="https://github.com/mishoo/UglifyJS">UglifyJS</a> to minify JS and CSS assets.</p>

<h3>Tip: Use webpack stats to review your modules</h3>

<p>Webpack can generate packing stats in json format while packing. We use <a href="https://chrisbateman.github.io/webpack-visualizer/">Webpack visualizer</a> to visualize it to find which part of our works can be optimized. It helps a lot by providing an detail view inside the bundled file.</p>

<p><img src="https://cdn-images-1.medium.com/max/1600/1*fNQylMzJclEm5VDbVuHwVQ.png" alt="webpack viz" /></p>

<h2>Minifying HTML</h2>

<p><a href="https://github.com/ampedandwired/html-webpack-plugin">HTML webpack plugin</a> can help minifying HTML. Here is an example config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">new</span> <span class="nx">HtmlWebpackPlugin</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">template</span> <span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;../src/template.html.ejs&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">filename</span> <span class="o">:</span> <span class="s1">&#39;index.html&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">title</span>    <span class="o">:</span> <span class="s1">&#39;河狸家&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">inject</span>   <span class="o">:</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">minify</span>   <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">html5</span>                          <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">collapseWhitespace</span>             <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">minifyCSS</span>                      <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">minifyJS</span>                       <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">minifyURLs</span>                     <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">removeAttributeQuotes</span>          <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">removeComments</span>                 <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">removeEmptyAttributes</span>          <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">removeOptionalTags</span>             <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">removeRedundantAttributes</span>      <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">removeScriptTypeAttributes</span>     <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">removeStyleLinkTypeAttributese</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">useShortDoctype</span>                <span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}),</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Minifying SVG</h2>

<p>we are currently using <a href="https://github.com/rpominov/svgo-loader">svgo-loader</a> to keep SVGs clean.</p>

<p>before:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; standalone=&quot;no&quot;?&gt;</span>
</span><span class='line'><span class="cp">&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot; &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;</span>
</span><span class='line'><span class="nt">&lt;svg</span> <span class="na">width=</span><span class="s">&quot;100%&quot;</span> <span class="na">height=</span><span class="s">&quot;100%&quot;</span> <span class="na">viewBox=</span><span class="s">&quot;0 0 10 18&quot;</span> <span class="na">version=</span><span class="s">&quot;1.1&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="na">xmlns:xlink=</span><span class="s">&quot;http://www.w3.org/1999/xlink&quot;</span> <span class="na">xml:space=</span><span class="s">&quot;preserve&quot;</span> <span class="na">style=</span><span class="s">&quot;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;path</span> <span class="na">id=</span><span class="s">&quot;Shape-Copy&quot;</span> <span class="na">d=</span><span class="s">&quot;M9.157,0.136L0.157,8.636C-0.052,8.834 -0.052,9.166 0.157,9.364L9.157,17.864C9.357,18.053 9.674,18.044 9.864,17.843C10.053,17.643 10.044,17.326 9.843,17.136L1.222,8.994L9.843,0.864C10.044,0.674 10.053,0.357 9.864,0.157C9.674,-0.044 9.357,-0.053 9.157,0.136Z&quot;</span> <span class="na">style=</span><span class="s">&quot;fill:rgb(189,157,98);&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/svg&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>after:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;svg</span> <span class="na">class=</span><span class="s">&quot;SVGInline-svg icon-svg&quot;</span> <span class="na">style=</span><span class="s">&quot;width: 1em;height: 1em;&quot;</span> <span class="na">viewBox=</span><span class="s">&quot;0 0 10 18&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="na">fill-rule=</span><span class="s">&quot;evenodd&quot;</span> <span class="na">clip-rule=</span><span class="s">&quot;evenodd&quot;</span> <span class="na">stroke-linejoin=</span><span class="s">&quot;round&quot;</span> <span class="na">stroke-miterlimit=</span><span class="s">&quot;1.414&quot;</span><span class="nt">&gt;&lt;path</span> <span class="na">d=</span><span class="s">&quot;M9.157.136l-9 8.5a.5.5 0 0 0 0 .728l9 8.5a.5.5 0 0 0 .686-.728l-8.62-8.142 8.62-8.13a.5.5 0 0 0-.686-.728z&quot;</span> <span class="na">fill=</span><span class="s">&quot;#bd9d62&quot;</span><span class="nt">&gt;&lt;/path&gt;&lt;/svg&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Minifying bitmap Images</h2>

<p><a href="https://github.com/tcoopman/image-webpack-loader">Image-webpack-loader</a> can save a lot bandwidth.</p>

<h2>Conclusion</h2>

<p>Webpack provides a powerful way of web developing, we use some plugins to automating the deployment. and there are more out of our view. So let&rsquo;s keep exploring and make web development more enjoyable.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setting Up Your React Project Is Easier Than You Think]]></title>
    <link href="http://q.pnq.cc/blog/2016/05/02/shi-yong-yeomankuai-su-da-jian-reactkai-fa-huan-jing/"/>
    <updated>2016-05-02T22:16:08+08:00</updated>
    <id>http://q.pnq.cc/blog/2016/05/02/shi-yong-yeomankuai-su-da-jian-reactkai-fa-huan-jing</id>
    <content type="html"><![CDATA[<p>I have heard some ones complaining that setting up a <a href="https://webpack.github.io/">Webpack</a> + <a href="https://facebook">React</a> project is not an easy job. It&rsquo;s only partly true. <a href="https://webpack.github.io/">Webpack</a> is not well documented at this moment, and has many powerful features and plugins. This makes configuration on <a href="https://webpack.github.io/">Webpack</a> seem difficult to new developers. To make things even worse, there are tons of &lsquo;starter kit&rsquo; projects over there, most of which are lack of maintainance.</p>

<p><img src="http://yeoman.io/static/yeoman-02.83c46c7213.png" alt="Yeoman" /></p>

<p>Indeed, it is super easy to setup a brand new <a href="https://webpack.github.io/">Webpack</a> + <a href="https://facebook">React</a> project using <a href="http://yeoman.io/">Yeoman</a>.</p>

<p><a href="http://yeoman.io/">Yeoman</a> is a scaffolding tool for web developers. With diffrent <code>generators</code> we can generate different kinds of web projects quickly by lines of command.</p>

<p>Here&rsquo;s how it is done:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># install Yeoman command and generator</span>
</span><span class='line'>npm install -g yo
</span><span class='line'>npm install -g generator-react-webpack
</span><span class='line'>
</span><span class='line'><span class="c"># generate project</span>
</span><span class='line'>mkdir <span class="nb">test</span>-project
</span><span class='line'><span class="nb">cd test</span>-project
</span><span class='line'>yo react-webpack
</span></code></pre></td></tr></table></div></figure>


<p>Thanks to <a href="https://github.com/newtriks/generator-react-webpack">generator-react-webpack</a>, after answering some questions from <code>yo</code> you will get your project setup in seconds.</p>

<p>Easy and quick, right? Here&rsquo;s what we have got out of the box:</p>

<ul>
<li>a project with Webpack and React configured;</li>
<li>a solution for diffrent environments both for runtime and webpack configuration;</li>
<li>a <a href="https://facebook.github.io/flux/">flux</a> project structure;</li>
<li>an optional <a href="http://postcss.org/">PostCSS</a> setup</li>
</ul>


<p>Also this generator can help <a href="https://github.com/newtriks/generator-react-webpack#generating-new-components">generate React components</a> via command line.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[为什么写不出博客了]]></title>
    <link href="http://q.pnq.cc/blog/2016/05/02/why-not-write-any-more/"/>
    <updated>2016-05-02T21:41:39+08:00</updated>
    <id>http://q.pnq.cc/blog/2016/05/02/why-not-write-any-more</id>
    <content type="html"><![CDATA[<p>近几年以来，我写博客的数量每况愈下，从几个月一篇，到几个季度一篇，现在已经将近一年一篇了。。 (✖╭╮✖)</p>

<p>今天也是无意间提起，让我思考这个问题</p>

<h2>为什么越来越不写博客了呢？</h2>

<ol>
<li><p>首先想到的是「懒」+「忙」</p>

<p> 但其实「没时间」是一个最不成立的理由，所谓的「没时间」往往是「优先级不高」的幌子罢了。很多时候不忙，心里知道有很多事情应该去做，却什么也不想做。<a href="http://baike.baidu.com/subview/26649/19131821.htm?fromtitle=%E7%8E%8B%E9%98%B3%E6%98%8E&amp;fromid=5710&amp;type=syn">阳明先生</a> 说没有「知易行难」这件事，不「行」是由于「知」得还不彻底。是的，我没有在自己心里把写博客重视起来当一回事，当成一定<strong>非完成不可的</strong>的事情。</p></li>
<li><p>追求的事物已发生了转移?</p>

<p> 是以前对技术更感兴趣一些，现在不感兴趣了吗？似乎也不是，现在每天起来之后也会阅读技术文章。对技术反而比以前更执着了。</p></li>
<li><p>害怕写不好</p>

<p> 以前反而大胆一些，也不怕误导别人；现在反而一些就想写很多，想写一个系列，系统地传授一系列的知识，系统地引导别人掌握一个东西。想做的事情太大，又没有足够的精力去做，于是就这样了。</p></li>
</ol>


<p>原因算是找到了。</p>

<h2>Done better than perfect</h2>

<p>写得差总比不写要好，其实我的 blog 访问量那么低，也误导不了几个人。何况我最近也想明白了，没有所谓的「误导」，每个人都需要有自己的判断力，看到别人的论点需要有甄别的能力。阅读是自己的权利，判断也是自己的义务。坚持推荐我认为「好」的事物，就算因此让别人走了弯路，相信这种弯路也会是一种积累的。</p>

<p>所以我决定，从这篇开始，要多写写一些短小的技术文章了。即便没有人看也没关系，回归当初写 blog 的心境，记录自己的成长。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[为什么 limits 不生效]]></title>
    <link href="http://q.pnq.cc/blog/2015/08/09/why-the-limits-config-not-hornored/"/>
    <updated>2015-08-09T21:14:35+08:00</updated>
    <id>http://q.pnq.cc/blog/2015/08/09/why-the-limits-config-not-hornored</id>
    <content type="html"><![CDATA[<p>最近遇到一个奇怪的问题，无法将服务器的最大文件打开数量提高。</p>

<p>服务器是 Ubuntu Server 14.04</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$lsb_release</span> -a
</span><span class='line'>No LSB modules are available.
</span><span class='line'>Distributor ID:   Ubuntu
</span><span class='line'>Description:  Ubuntu 14.04.2 LTS
</span><span class='line'>Release:  14.04
</span><span class='line'>Codename: trusty
</span></code></pre></td></tr></table></div></figure>


<p>正常情况下， <code>/etc/security/limits.conf</code> 的改动，应该在下次访问时就生效才对。
但是总是没生效，查了很多资料，尝试了很多修改，终于成功了</p>

<h2>记录一下填的坑：</h2>

<h3>1. 确保 pam 生效</h3>

<p>在 <code>/etc/pam.d/login</code> 中，存在:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>session required pam_limits.so
</span></code></pre></td></tr></table></div></figure>


<h3>2. 确保 ssh 使用 pam</h3>

<p>在 <code>/etc/pam.d/sshd</code> 中，存在:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>session required pam_limits.so
</span></code></pre></td></tr></table></div></figure>


<p>在 <code>/etc/ssh/ssd_config</code> 中, 存在:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>UsePAM yes
</span></code></pre></td></tr></table></div></figure>


<h3>3. limits.conf 建议不要使用星号</h3>

<p>官方 manual 以及网上的教程有很多都用了 <code>*</code> 符号，然而不是所有系统都认的，我最后发现问题就是在这里！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># 不兼容方式:</span>
</span><span class='line'>* soft nofile 51200
</span><span class='line'>* hard nofild 51200
</span><span class='line'>
</span><span class='line'><span class="c"># 兼容方式</span>
</span><span class='line'>root soft nofile 51200
</span><span class='line'>root hard nofile 51200
</span><span class='line'>
</span><span class='line'>qhwa soft nofile 51200
</span><span class='line'>qhwa hard nofile 51200
</span></code></pre></td></tr></table></div></figure>


<h2>如何确认问题之所在</h2>

<h3>查看当前用户的 limits</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">ulimit</span> -a
</span></code></pre></td></tr></table></div></figure>


<h3>查看另外一个用户的 limits</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># 注意 ulimit 不是命令，而是 shell 方法</span>
</span><span class='line'>sudo -u &lt;USER&gt; sh -c <span class="s1">&#39;ulimit -a&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>经过 ssh 查看用户的 limits</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>ssh example.com <span class="s1">&#39;ulimit -a&#39;</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[capistrano-hostmenu: 只操作指定的服务器]]></title>
    <link href="http://q.pnq.cc/blog/2015/02/11/capistrano-deloy-only-to-selected-servers/"/>
    <updated>2015-02-11T22:10:44+08:00</updated>
    <id>http://q.pnq.cc/blog/2015/02/11/capistrano-deloy-only-to-selected-servers</id>
    <content type="html"><![CDATA[<p>想必大家都用过 <a href="http://capistranorb.com/">capistrano</a> 了，部署代码到多个服务器上的神器。
不过使用中有个不太方便的地方是，某些情况下只想部署到其中几台。</p>

<p>例如我们新增了一个功能，但只想找一台服务器先部署上去测试一下，成功后再部署到整个集群。</p>

<p>有好几种方式可以做到：</p>

<ol>
<li>临时修改发布脚本（<code>config/deploy.rb</code> 或 <code>config/deploy/***.rb</code>）</li>
<li>使用 <code>HOST</code> 命令行环境变量，或者 <code>--host</code> 参数, 比如 <code>HOST=example.com cap production deploy</code></li>
</ol>


<p>第1种不好重用，第2种在 <a href="http://capistranorb.com/">capistrano</a> v3.3 以上版本已经失效了。</p>

<p>我把我们项目中用的 task 抽出来做成了一个 gem: <a href="https://github.com/qhwa/capistrano-hostmenu">capistrano-hostmenu</a>
功能实在是太简单，没有什么好描述的。。</p>

<p>一图顶千言：</p>

<p><img src="https://ruby-china-files.b0.upaiyun.com/photo/2015/fd0dc13527ea01a9c5461ddc2b37638a.png" alt="" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[如何开发 ruby 命令行工具]]></title>
    <link href="http://q.pnq.cc/blog/2014/11/16/a-little-project-for-download-huaban-pins/"/>
    <updated>2014-11-16T15:54:01+08:00</updated>
    <id>http://q.pnq.cc/blog/2014/11/16/a-little-project-for-download-huaban-pins</id>
    <content type="html"><![CDATA[<p>最近 @季子乌 的 <a href="http://huaban.com/pigeonzhu">花瓣账号</a> 突然被封，苦心采集的很多图片一下子全部看不到了！</p>

<p>后来虽然联系客服重新开通了账号，但还是心有余悸，觉得还是 <a href="http://www.pinterest.com/">pinterest</a> 靠谱一些，准备把图片全部迁移到 pinterest 上。由于图片数量比较多，我就用 ruby 写了一个工具，将花瓣上的图片下载下来。（不过 pinterest 不能批量上传，这些图片也只是备份到本地，这是后话了）</p>

<p>这个项目已开源，地址是：
<a href="https://github.com/qhwa/huaban_exporter">https://github.com/qhwa/huaban_exporter</a></p>

<p>这个工具下载后，可以用执行 <code>huaban</code> 命令</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>huaban <span class="nb">export </span>boards --of qhwa
</span></code></pre></td></tr></table></div></figure>


<p>执行效果：</p>

<p><img src="https://xiaotuhe.com/uploads/share/file/58904c1c21892b12963cca37291e6547.gif" alt="preview" /></p>

<p>我喜欢用命令行工作，之前做的几个 gem（<a href="https://github.com/qhwa/lfd">lfd</a>, <a href="https://github.com/qhwa/fdlint">fdlint</a>）也都提供了命令行。这次就趁这个项目总结了一下怎样用 ruby 开发友好的命令行工具。</p>

<h3>I. 初期怎样提高开发效率？</h3>

<p>在写了基础的一些逻辑 model 后，我写个简单的 <a href="https://github.com/qhwa/huaban_exporter/blob/69b16009357a87f2e6e645801694a16b65803a41/Rakefile">rake 文件</a>，初期用 rake 来作为入口，边开发边测试。</p>

<p>一开始我只建了这样的一个 rake 任务，来调试获取画板列表功能：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rake boards         <span class="c"># 列出一个用户的所有画板 (user=用户名 rake boards)</span>
</span></code></pre></td></tr></table></div></figure>


<p>后来随着功能不断完成，逐渐增加了几个新的任务，最后是完整的任务：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rake boards         <span class="c"># 列出一个用户的所有画板 (user=用户名 rake boards)</span>
</span><span class='line'>rake export_board   <span class="c"># 导出一个画板的所有图片到本地 (board_id=画板id  rake export_board)</span>
</span><span class='line'>rake export_boards  <span class="c"># 导出用户所有的画板图片到本地 (user=用户名 rake export_boards)</span>
</span><span class='line'>rake pins           <span class="c"># 列出一个画板所有的采集 (board_id=画板id rake pins)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>II. 项目后期功能稳定后，怎么做命令行入口</h3>

<p>rakefile 很适合自己用，但是要分发别人用，用 rakefile 就不方便了。做成带命令行脚本的 gem 更加方便。</p>

<ul>
<li>把你的脚本放到 <code>bin</code> 目录下</li>
<li>加上执行权限(<code>chmod a+x</code>)</li>
<li>加上 <a href="http://zh.wikipedia.org/zh-cn/Shebang">shebang</a>, 比如 <code>#!/usr/bin/env ruby</code></li>
</ul>


<blockquote><p>这一步我以前是用下面提到的 gli 来自动进行，但后来改成手动做了。因为 gli 生成了一些额外的文件，和 bundle 有点冲突。</p></blockquote>

<h3>III. 怎样让命令变得友好?</h3>

<p>有个超棒的 gem 叫做 <a href="https://github.com/davetron5000/gli">gli</a>，帮你很容易实现出类似 git 这样风格的脚本</p>

<h3>IV. 项目完成后，怎么用做成一个 gem，分享给别人?</h3>

<p><a href="http://bundler.io/">bundler</a> 提供了生成 gem 的功能</p>

<ol>
<li><code>bundle gem &lt;name&gt;</code> 生成目录结构</li>
<li>修改 gemspec</li>
<li><code>rake install</code> 先在本地安装这个 gem 进行测试</li>
<li><code>rake build</code>   以最新的文件重新打包成 gem</li>
<li><code>gem push pkg/&lt;版本&gt;.gem</code> 将gem上传到 <a href="https://rubygems.org">https://rubygems.org</a></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SSL Notes With Ruby on Rails]]></title>
    <link href="http://q.pnq.cc/blog/2014/10/13/ssl-notes-with-rails/"/>
    <updated>2014-10-13T15:54:01+08:00</updated>
    <id>http://q.pnq.cc/blog/2014/10/13/ssl-notes-with-rails</id>
    <content type="html"><![CDATA[<p>上周我给<a href="https://xiaotuhe.com">小兔盒</a>加上了https，比想象中容易许多。记录一下</p>

<h3>免费的CA:</h3>

<p>之前一直以为 CA 是需要每年付一笔不菲的费用的，但其实也有免费的，例如：</p>

<ul>
<li><a href="https://buy.wosign.com/free/">https://buy.wosign.com/free/</a> (推荐)</li>
<li><a href="https://www.startssl.com/">https://www.startssl.com/</a></li>
</ul>


<p>按照网站指示，可以获得由其颁发的证书 有两个文件(certification &amp; key) 是后面工作的基础。</p>

<h3>在开发环境中使用 https (无需nginx)</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>thin start --ssl --ssl-key-file YOUR_SSL_KEY_FILE --ssl-cert-file YOUR_CERT_FILE
</span></code></pre></td></tr></table></div></figure>


<h3>一些 tips</h3>

<h4>url helpers</h4>

<p>不管当前 request 是 https 还是 http，rails 的 url_helper 都使用 http</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># file: config/routes:</span>
</span><span class='line'><span class="n">root</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;home#index&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># in views or helpers:</span>
</span><span class='line'><span class="n">root_url</span>                    <span class="c1">#=&gt; http://YOUR_SITE/</span>
</span><span class='line'><span class="n">root_url</span> <span class="ss">protocol</span><span class="p">:</span> <span class="s1">&#39;https&#39;</span>  <span class="c1">#=&gt; https://YOUR_SITE/</span>
</span></code></pre></td></tr></table></div></figure>


<h4>使用 protocol 无关的 assets 地址</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># file: config/environments/production.rb</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">action_controller</span><span class="o">.</span><span class="n">asset_host</span> <span class="o">=</span> <span class="s1">&#39;//YOUR-CDN.com&#39;</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>用工具检查</h4>

<p>有很多工具可以检查 https 部署情况，例如这个：
<a href="https://www.sslshopper.com/ssl-checker.html">https://www.sslshopper.com/ssl-checker.html</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[石潭村游记]]></title>
    <link href="http://q.pnq.cc/blog/2014/04/08/shi-tan-cun-you-ji/"/>
    <updated>2014-04-08T20:58:38+08:00</updated>
    <id>http://q.pnq.cc/blog/2014/04/08/shi-tan-cun-you-ji</id>
    <content type="html"><![CDATA[<p><img src="http://pnqcc.qiniudn.com/shitancun2674856703781518773.jpg" alt="石潭村" /></p>

<p>石潭村在安徽省黄山市徽州区歙县霞坑镇，距离黄山市50多公里，离杭州余杭150公里多点。我们在杭州，所以过去很近，非常适合清明小长假自驾游。从杭州往西，一路有天目山、青山湖这样的景区，即便是在高速公路上，也能看到路边的小风景。</p>

<p>杭徽高速西行大约120km，之后是省道。经过一段蜿蜒刺激的盘山公路，又穿过几个热闹的小镇子，就来到了车子能开到的尽头——石潭村。啰嗦几句，实际上还能往前开，只是政府封了路，里面的路外地车进不去，只能乘坐当地的小商务车，一辆车可以坐八个人。网上也有老的攻略说石潭村里面还有十几个村子，进去需要徒步。其实我们发现已经修了不少水泥路进去，车子可以一直开到5公里深的大龙湾。一路依山傍水，满目都是油菜花，黑砖白墙的村落点缀其间，风景很美。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun2162572246168650691.jpg" alt="路边" /></p>

<p>我们是当天下午到的石潭村，在村口打尖吃饭，人还挺少的。暗自庆幸来对了地方，是个清净的地方。吃完饭再往前走了1公里路，正式进了村子，才发现实际情况稍微糟糕了一点。人虽然没有比肩继踵，但是已经把小村子挤得满满的了，很困难地找了车位，然后随便选了一家名字看上去比较正规的旅店住下，放了行李。</p>

<p>这家旅店的名字有好几部分组成，我们只记得第一部分“游侠客”，后面那部分所有人都没记住，因为看到“游侠客”三个字，有人就兴奋地说认识游侠客的创始人，我们就决定入住这家亲切的旅店了。</p>

<p>有了地方住，心里就踏实了。放下行李，我们一行人就兴致勃勃地出发，往村里头扑去。</p>

<h2>石潭村</h2>

<p>村子依山傍水而建。山并不高，一条小溪从山间穿过，将石潭村一分为二。溪水不算多，但是很清澈。河滩上有许多青色的鹅卵石。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun6599324865005478015.jpg" alt="玩水" /></p>

<p>我们在小溪边玩了一会，然后就开始随便行走。</p>

<p>村边菜地里面油菜花还开着一些，但是也有许多已经谢了，结了果实。还有葱，一些蚕豆，长得都很粗壮。村子里面很安静。房子都很老，但历史并不长。清一色的白墙，绘了深色的花边，古色古香。有几间木结构的老屋子，看上去很精致。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun1505328175549109622.jpg" alt="村子" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun2670916054107569546.jpg" alt="村子" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun4926093567513430064.jpg" alt="村子" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun4884998220913673644.jpg" alt="村子" /></p>

<p>走着走着，就出了村子，来到了后山。看上去有路往里面走，据说是到另外的村子去的。这时候太阳已经快下山了，我们就决定不继续往前了。但是往回走又心有不甘，才没出来多久呢！边上的小山上，菜地里面中了很多油菜花，好像可以上去的样子，可是又不见有路。这时鸽子mm 咻咻地爬了上去，大家也跟着，顺着隐隐约约的小坎，爬了上去。</p>

<p>上去之后，穿过齐头高的油菜田，来到另一边山头，美景就这么突然映入眼帘。山下的村子，小溪，对面的林子、夕阳，和清新的空气一起，像画一样。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun3027263374623346861.jpg" alt="山坡" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun6608181431166740222.jpg" alt="夕阳" /></p>

<p>放下野餐毯，大家坐在一起，吃吃喝喝，好不快活！</p>

<p>慢慢地太阳从对面的山头下去了。我们也下山，继续沿着小溪散步。然后就回到旅店稍作休息，便开始找吃晚饭的地方。</p>

<p>晚饭在另外一家本地的食宿一体的旅店吃的。菜很好吃，加上大家有点累，都觉得很美味。回到杭州后鸽子还认真地在大众点评上给了4星好评，这是后话了。</p>

<p>吃完饭已经不早，大家稍微讨论了一下第二天的行程，小朋友不喜欢坐船，所以坐船的方案就被否定了。但去哪里还是没什么定论。累了一天，大家纷纷洗澡睡了。</p>

<h2>大龙湾</h2>

<p>天刚蒙蒙亮，村子就已经苏醒了。出门务农的人，开张的早餐店，准备上山的摄友……外面逐渐嘈杂起来。</p>

<p>我6点时候醒了，躺在床上看了一下地图，觉得可以沿着小溪往下游走。看到小溪在一个叫做“大龙湾”的地方拐了大弯，有山有水有桥，觉得可以去看看。</p>

<p>其他同伴们还在睡觉中，我决定独自起来看看。</p>

<p>吃过白粥配咸菜的早餐，买了根刚炸出来的油条，在村外随便散步起来了。</p>

<p>早晨的景色果然更美。山中雾气缭绕，空气有点清凉，提神。远处的树林是一层层的，像水彩画一般。透过片片的油菜花，此时的村子最像水墨画了。</p>

<p>早上出门没有带相机，只有一个效果很差、不能自动对焦的手机。。。你们勉强感受一下好了。。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun6608410129585315688.jpg" alt="早晨" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun6608212217492318021.jpg" alt="早晨" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun2849652664319389629.jpg" alt="早晨" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun4874302171798598062.jpg" alt="早晨" /></p>

<p><img src="http://pnqcc.qiniudn.com/shitancun147211412920378673.jpg" alt="早晨" /></p>

<p>信步所至，都是美景。去哪应该都不错。</p>

<p>散步回来，大家已经陆续起床了。然后一起退房、出门，吃早饭，散步。简单商量了一下，就拦了一辆车往大龙湾去了。</p>

<p>沿途都是都是油菜花、小桥流水人家，大家都啧啧赞叹。</p>

<p>路上车、人都很少。开车的师傅说，我们是他见过的第一批去大龙湾的游客，上车的时候，他还以为我们是家在那边的呢！</p>

<p>大约10分钟不到，车子就飞驰到了目的地。</p>

<p>下车的地方，是村子外的桥头。清澈的山泉水沿着村民搭的竹筒子流在路上，又流进小溪。桥下的溪水很清，很多小鱼在不停嬉戏。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun3020789450159004124.jpg" alt="大龙湾" /></p>

<p>穿过桥就到了村子里面。</p>

<p>村子里静悄悄的，偶尔才看到骑自行车的小朋友从我们身边路过。后面还跟着一只小黄狗，好奇地嗅嗅我们，然后迅速追向主人了。</p>

<p>村里人少，但是很热情。我们在一位大爷家门口的长石板凳上坐下休息，和大爷聊天。</p>

<p>吃了点零食，稍微填了一点肚子。然后继续探索。</p>

<p>水边有一颗上了年纪的樟树，落下的叶子盖满了竹林间的小路。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun2986449503000247180.jpg" alt="樟树竹林" /></p>

<p>中饭本来想在水边烧烤的，但是走的时候没有带吃的东西，于是问一位采茶归来的老奶奶买了一些粽子、年糕，准备烧烤。不过老奶奶听说我们要生火，很是担心安全。。最后我们在老奶奶家借了灶，生火做饭。菜都是问老奶奶买的。</p>

<p>人们开始大秀厨艺。。</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun1145040205359656732.jpg" alt="做中饭" /></p>

<p>吃了一顿饱饱的中饭，时间也是下午两点了，刚好适合回杭州。打电话叫上午送我们过来的师傅来接我们回去，不过他有事，另外找了一个师傅来接我们。</p>

<p>这是我们在等车：</p>

<p><img src="http://pnqcc.qiniudn.com/shitancun3024448624856241351.jpg" alt="等车" /></p>

<p>回到石潭村，我们就心满意足地开车回杭州啦！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[chinese_number: 一个解析汉字数字的 ~rubygem]]></title>
    <link href="http://q.pnq.cc/blog/2014/03/18/chinse-number-gem/"/>
    <updated>2014-03-18T17:45:38+08:00</updated>
    <id>http://q.pnq.cc/blog/2014/03/18/chinse-number-gem</id>
    <content type="html"><![CDATA[<p><a href="http://ruby-china.org">ruby-china</a> 上有人问到<a href="http://ruby-china.org/topics/17913">怎么优雅地解析汉字数字</a>，比如 <code>二十五</code> 解析成 <code>25</code> 。我第一反应是应该查一下有没有这样的 gem，因为是一个很普遍的需求，说不定已经有人实现了呢！</p>

<p>不过很可惜，不知道是不是我没有查到，还是真的没有，总之没有找到。所以我就写了一个这样的 gem &mdash; <strong><a href="https://github.com/qhwa/chinese_number">chinese_number</a></strong></p>

<p>用法很简单：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;chinese_number&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">ChineseNumber</span><span class="o">.</span><span class="n">trans</span> <span class="s1">&#39;今天二十万&#39;</span>
</span><span class='line'><span class="c1">#=&gt; &quot;今天200000&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="no">ChineseNumber</span><span class="o">.</span><span class="n">find</span> <span class="s2">&quot;一年有十二个月三百六十五天&quot;</span>
</span><span class='line'><span class="c1">#=&gt; [{&quot;一&quot;=&gt;1}, {&quot;十二&quot;=&gt;12}, {&quot;三百六十五&quot;=&gt;365}]</span>
</span><span class='line'>
</span><span class='line'><span class="no">ChineseNumber</span><span class="o">.</span><span class="n">extract</span> <span class="s2">&quot;今天二十晚&quot;</span>
</span><span class='line'><span class="c1">#=&gt; [20]</span>
</span><span class='line'>
</span><span class='line'><span class="ss">ChineseNumber</span><span class="p">:</span><span class="ss">:Parser</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">parse</span> <span class="s1">&#39;二零一四&#39;</span>
</span><span class='line'><span class="c1">#=&gt; 2014</span>
</span><span class='line'>
</span><span class='line'><span class="ss">ChineseNumber</span><span class="p">:</span><span class="ss">:Parser</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">parse</span> <span class="s1">&#39;一万三千&#39;</span>
</span><span class='line'><span class="c1">#=&gt; 13000</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[《代码的未来》 阅读笔记（1）—— JavaScript/CoffeScript/ruby 局部变量处理的异同]]></title>
    <link href="http://q.pnq.cc/blog/2014/03/18/variable-scope-in-js-coffeescript-and-ruby/"/>
    <updated>2014-03-18T16:21:00+08:00</updated>
    <id>http://q.pnq.cc/blog/2014/03/18/variable-scope-in-js-coffeescript-and-ruby</id>
    <content type="html"><![CDATA[<blockquote><p>…… 身为 JavaScript 程序员的好友说，对 javascript 的不满之一，就是它的变量声明和作用域。 —— Mats</p></blockquote>

<h2>JavaScript</h2>

<p>js 可以通过有无<code>var</code>来选择是否创建一个新的作用域：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="s2">&quot;out&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="s2">&quot;in&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">})();</span>
</span><span class='line'>
</span><span class='line'><span class="nx">alert</span><span class="p">(</span> <span class="nx">a</span> <span class="p">);</span>
</span><span class='line'><span class="c1">// &quot;out&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">a</span> <span class="o">=</span> <span class="s2">&quot;out&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">a</span> <span class="o">=</span> <span class="s2">&quot;in&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">})();</span>
</span><span class='line'>
</span><span class='line'><span class="nx">alert</span><span class="p">(</span> <span class="nx">a</span> <span class="p">);</span>
</span><span class='line'><span class="c1">// &quot;in&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>很灵活。不幸的是，不小心漏写最外层 <code>var</code> 之后，变量有可能会变成全局变量，这是容易滋生 bug 的地方。</p>

<h2>CoffeeScript</h2>

<p>CoffeeScript 中统一去掉了<code>var</code>，全部按局部变量处理，和 js 不同的是，不再创建内层作用域了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">a = </span><span class="s">&quot;out&quot;</span>
</span><span class='line'><span class="p">(()</span> <span class="nf">-&gt;</span>
</span><span class='line'>  <span class="nv">a = </span><span class="s">&quot;in&quot;</span>
</span><span class='line'><span class="p">)()</span>
</span><span class='line'><span class="nx">alert</span><span class="p">(</span> <span class="nx">a</span> <span class="p">)</span>
</span><span class='line'><span class="o">//</span> <span class="s">&quot;in&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Ruby</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># version 1</span>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;out&quot;</span>
</span><span class='line'><span class="p">(</span><span class="nb">lambda</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;in&quot;</span>
</span><span class='line'><span class="k">end</span><span class="p">)</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">a</span>
</span><span class='line'><span class="c1">#=&gt; &quot;in&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># version 2</span>
</span><span class='line'><span class="c1"># ruby 1.9+</span>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;out&quot;</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="p">;</span> <span class="n">a</span><span class="o">|</span> <span class="c1">#&lt;= 注意这里的分号</span>
</span><span class='line'>  <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;in&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">a</span>
</span><span class='line'><span class="c1">#=&gt; &quot;out&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ruby 中默认和 CoffeeScript 一致，使用外层作用域。但多了一种“作用域声明”，允许人工制定创建一个作用域。</p>

<p>结论</p>

<table>
<thead>
<tr>
<th> 语言 </th>
<th> 同名局部变量处理策略 </th>
</tr>
</thead>
<tbody>
<tr>
<td> js  </td>
<td> 内部优先，可以通过去掉 var 向上查找</td>
</tr>
<tr>
<td> coffeescript </td>
<td> 外部</td>
</tr>
<tr>
<td> ruby </td>
<td> 外部优先，可以通过声明强制使用内部</td>
</tr>
</tbody>
</table>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[编程原则]]></title>
    <link href="http://q.pnq.cc/blog/2013/07/18/programing-on-principles/"/>
    <updated>2013-07-18T11:49:00+08:00</updated>
    <id>http://q.pnq.cc/blog/2013/07/18/programing-on-principles</id>
    <content type="html"><![CDATA[<ol>
<li>in/out 原则：签入的代码一定要比签出时更好</li>
<li>变量命名选用最贴切、最短的</li>
<li>只为当前的需求考虑设计</li>
<li>出现当前设计无法满足的新需求时，重构设计，使用最合理的，而不是满足需求的设计</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[折纸折叠菜单效果]]></title>
    <link href="http://q.pnq.cc/blog/2012/11/30/fancy-paper-list/"/>
    <updated>2012-11-30T00:00:00+08:00</updated>
    <id>http://q.pnq.cc/blog/2012/11/30/fancy-paper-list</id>
    <content type="html"><![CDATA[<p>这个效果原先是给团队内部的一个协作网站开发的</p>

<iframe src="http://cssdeck.com/labs/full/fancy-paper-list" width="100%" height="700" ></iframe>


<p>暂时还没有时间详细写过程，有兴趣的可以看看代码，交流一下</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[利用 Grunt （几乎）无痛地做前端开发 (一)]]></title>
    <link href="http://q.pnq.cc/blog/2012/11/30/_grunt-1/"/>
    <updated>2012-11-30T00:00:00+08:00</updated>
    <id>http://q.pnq.cc/blog/2012/11/30/_grunt-1</id>
    <content type="html"><![CDATA[<h2>前言</h2>

<blockquote><p>如果你想开发一个js应用，甭管多简单，都要先创建整个宇宙</p></blockquote>

<p>来看看我们的Javascript小宇宙:</p>

<ol>
<li>确定如何根据需求、功能划分模块，如何将代码分成多个文件开发，合成一个发布</li>
<li>保证上一条的同时，使用 Coffeescript、SCSS/LESS 等技术</li>
<li>保证上2条的同时，想想怎么在浏览器的刷新后一切都最新</li>
<li>保证上3条的同时，想想怎么在开发、测试、生产、预发布环境中都OK</li>
<li>保证上4条的同时，进行TDD式的开发</li>
<li>&hellip;这还是js, 我们还没有涉及到HTML</li>
</ol>


<p>Grunt 可以将创建小宇宙的工作变得轻松很多。</p>

<h2>初识 grunt</h2>

<p>以一个jQuery插件的开发为例。 开始之前，让我们先安装Grunt.</p>

<p>首先需要<a href="http://nodejs.org/">Nodejs</a>环境，这里假设你已经安装好了<a href="http://nodejs.org/">Nodejs</a>和<a href="https://npmjs.org/">NPM</a>.</p>

<p>然后安装 grunt :</p>

<pre><code>npm install grunt
</code></pre>

<blockquote><p>命令行方式更适合前端开发。这里我都用命令行来进行操作，windows用户推荐用git-shell或者powershell.</p></blockquote>

<h3>第一招：快速搭建脚手架</h3>

<p>Grunt 已经安装好了，第一步就是利用grunt快速搭建脚手架出来。所谓的脚手架，就是指包含了目录结构和初始的一些功能,测试文件的一个环境。我们来搭建一个jquery插件的脚手架：</p>

<pre><code>grunt init:jquery
</code></pre>

<p>这时grunt会问你一些问题，比如项目名称, git地址,作者等等，比如:</p>

<p><img src="http://img03.taobaocdn.com/tfscom/T1EwSRXyNhXXaCwpjX.png_620x10000.jpg" alt="initing" /></p>

<p>可以看到，grunt已经帮我们创建了一些经常出现的文件(README, LICENSE等), 单元测试也准备好了。</p>

<blockquote><p>有些问题可以<a href="https://github.com/gruntjs/grunt/blob/master/docs/task_init.md#specifying-default-prompt-answers">配置一下默认回答</a>，这样就不需要每次都重新输入了，只要敲回车就行。</p></blockquote>

<h3>第二招：TDD(测试驱动开发） 和 单元测试</h3>

<p>现在我们就可以着手写grunt-demo-1这个插件了。假设我们这个插件的目的是让页面上*.alibaba.com域名下的a链接都带上一个图标。那么可以写一些简单的qunit用例。</p>

<p>首先在<code>test/grunt-demo-1.html</code>准备好HTML用例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>...
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;qunit-fixture&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#functional-link&quot;</span><span class="nt">&gt;</span>#nogo<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://alibaba.com&quot;</span><span class="nt">&gt;</span>grunt<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://china.alibaba.com&quot;</span><span class="nt">&gt;</span>grunt<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://style.china.alibaba.com&quot;</span><span class="nt">&gt;</span>grunt<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://q.pnq.cc&quot;</span><span class="nt">&gt;</span>qhwa<span class="nt">&lt;/a&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span><span class='line'>....
</span></code></pre></td></tr></table></div></figure>


<p>打开上一步grunt已经帮我们生成的<code>test/grunt-demo-1_test.js</code>，写上我们自己的单元测试:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// file: test/grunt-demo_test.js</span>
</span><span class='line'><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;jQuery#ali-link&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">elems</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#qunit-fixture&#39;</span><span class="p">).</span><span class="nx">children</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;is chainable&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">strictEqual</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">elems</span><span class="p">.</span><span class="nx">alilink</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nx">elems</span><span class="p">,</span> <span class="s1">&#39;should be chaninable&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;can select&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">equal</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;a:alilink&#39;</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#qunit-fixture&#39;</span><span class="p">)).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;should select links with alibaba domain&#39;</span>
</span><span class='line'>  <span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;add icon to alibaba links&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">elems</span><span class="p">.</span><span class="nx">alilink</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">elems</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span> <span class="sr">/^http:\/\/((.+)\.)?alibaba\.com/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">href</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">ok</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;ali-link&#39;</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;ali-link&#39;</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后在命令行运行一下<code>grunt qunit</code>
运行结果是这样的：</p>

<p><img src="http://img03.taobaocdn.com/tfscom/T181NBFn4fXXaCwpjX.png" alt="grunt qunit first run" /></p>

<p>各种报错，对吧？不要紧，因为我们还没有开始写代码。接下来我们的目标就是写功能代码，让这个测试通过。</p>

<p>经过一番敲击键盘，以及运行了几次<code>grunt qunit</code>，终于，激动人心时刻到来了，我们通过了所有的单元测试:</p>

<p><img src="http://img01.taobaocdn.com/tfscom/T1p5RDFn4bXXaCwpjX.png_620x10000.jpg" alt="grunt qunit pass" /></p>

<p>最终的功能js如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// file: src/grunt-demo-1.js</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">ALI_LINK_REG</span> <span class="o">=</span> <span class="sr">/^http:\/\/(.+\.)?alibaba\.com/</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Collection method.</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">alilink</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="nx">isAliLink</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">){</span>
</span><span class='line'>        <span class="nx">self</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;ali-link&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">self</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;ali-link&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Custom selector.</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">expr</span><span class="p">[</span><span class="s1">&#39;:&#39;</span><span class="p">].</span><span class="nx">alilink</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">isAliLink</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">isAliLink</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="sr">/A/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">tagName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">ALI_LINK_REG</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">href</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}(</span><span class="nx">jQuery</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>想用jasmine? 当然可以了！ 社区有 <a href="https://npmjs.org/package/grunt-jasmine-runner">grunt-jasmine-runner</a></p></blockquote>

<p>功能已经完成了，但是插件就完成了吗？非也！</p>

<p>有了单元测试，我们可以放心重构我们的代码，达到最好的可维护性。先让机器帮我们做个code review——也就是linting。</p>

<p>准备好了，就来看下一招：</p>

<h3>第三招：利用 lint 提高代码质量</h3>

<p>运行命令 <code>grunt lint</code> ，果然有报警：</p>

<p><img src="http://img03.taobaocdn.com/tfscom/T1qp8CFmXbXXaCwpjX.png_620x10000.jpg" alt="grunt lint fail" /></p>

<p>嗯，我们的正则表达式写法不太好，那就来优化一下吧！</p>

<p>又经过一阵修改，我们的代码终于在 <code>grunt lint</code> 时没有报警了，不错！</p>

<p><img src="http://img01.taobaocdn.com/tfscom/T1KuBqFhthXXaCwpjX.png_620x10000.jpg" alt="grunt lint pass" /></p>

<p>运行一下 <code>grunt qunit</code> ，看到单元测试还能通过，功能正常，不错！</p>

<h3>第四招：利用 watch 自动化</h3>

<p>上面我们在重构和优化的时候，每次修改了功能js都要运行一遍<code>grunt qunit</code>和<code>grunt lint</code>，grunt 可以帮我们做到一旦有修改，自动运行这两个命令，方便吧？</p>

<p>很简单，运行<code>grunt watch</code> 就好了。然后试一下修改 src/ 下面的 js，就不需要手动去运行qunit和lint任务了。
watch 就是这样的一个任务，监测一些文件，都有更新的时候，自动运行需要的任务。</p>

<p><img src="http://img03.taobaocdn.com/tfscom/T1bb4BFodfXXaCwpjX.png_620x10000.jpg" alt="grunt watch" /></p>

<p>grunt 还自带了一些其他的任务，比如</p>

<ul>
<li>用来压缩js和css的<code>min</code> 任务</li>
<li>用来开启一个本地http服务器的 <code>server</code> 任务</li>
<li>用来将几个文件合并成一个的 <code>concat</code> 任务</li>
</ul>


<p>这些都是我们经常使用的任务。</p>

<h2>小结</h2>

<p>本文的示例代码已经放到 <a href="https://github.com/qhwa/grunt-demo">github 上</a>。</p>

<p>这一篇我们认识了 grunt ，下一篇将会看到 grunt 这种以任务为中心的设计，带来的强大扩展性。如果上面的例子已经让你感受到了无痛开发的乐趣，那么那些社区插件保证会让你更过瘾的！敬请期待本系列的第二篇—— 让 grunt 飞起来！</p>

<h2>参考</h2>

<p><a href="https://github.com/gruntjs/grunt/blob/master/docs/task_init.md">grunt init</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby 如何“反转义”字符串]]></title>
    <link href="http://q.pnq.cc/blog/2012/06/07/ruby-undecoding/"/>
    <updated>2012-06-07T00:00:00+08:00</updated>
    <id>http://q.pnq.cc/blog/2012/06/07/ruby-undecoding</id>
    <content type="html"><![CDATA[<p>我们知道Ruby中转义字符串可以用inspect或者dump可以将字符串转义：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">t&quot;</span><span class="o">.</span><span class="n">dump</span>       <span class="c1">#=&gt; &quot;\\&quot;\\\\t\\&quot;&quot;</span>
</span><span class='line'><span class="s2">&quot;中文&quot;</span><span class="o">.</span><span class="n">dump</span>     <span class="c1">#=&gt; &quot;\\&quot;\\\\u{4e2d}\\\\u{6587}\\&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>但有时候我们想把已经被转义的字符串反转义回正常的字符串，怎么办?</p>

<p>其实方法很简单：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">unescape</span><span class="p">(</span> <span class="n">src</span> <span class="p">)</span>
</span><span class='line'>  <span class="nb">String</span><span class="o">.</span><span class="n">class_eval</span><span class="p">(</span><span class="sx">%Q(&quot;</span><span class="si">#{</span><span class="n">src</span><span class="si">}</span><span class="sx">&quot;)</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">p</span> <span class="n">unescape</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">t</span><span class="se">\\\\</span><span class="s2">n&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">t</span><span class="se">\\</span><span class="s2">n&quot;</span>  <span class="c1">#=&gt; true</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用Apache Benmark(ab) 对一个 Ruby Web 程序做性能测试]]></title>
    <link href="http://q.pnq.cc/blog/2012/06/07/ab/"/>
    <updated>2012-06-07T00:00:00+08:00</updated>
    <id>http://q.pnq.cc/blog/2012/06/07/ab</id>
    <content type="html"><![CDATA[<p>最近要在一些内部系统中嵌入<a href="https://github.com/qhwa/fdlint-host/">fdlint</a>的功能，检查HTML的语法是否正确。涉及到了系统性能测试的问题，学习了一下，在这里记录一下。</p>

<p>首先是工具的选择，apache自带的性能测试工具ab简单方便，就用他了！</p>

<h2>首页（静态页面）的测试</h2>

<p>很简单的一个命令搞定:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ab -n &lt;总数&gt; -c &lt;并发上限&gt; http://fdlint.mysite.com/
</span></code></pre></td></tr></table></div></figure>


<p>注意最后的斜杠(&ldquo;/&rdquo;)没有的话命令会报错。-__&ndash;</p>

<h2>功能页面(动态)的测试</h2>

<p>这个页面需要接受一个form表单(POST形式). 这时可以用ab的参数q指定一个POST数据的内容。</p>

<p>第一步先准备原始数据素材。我这需要提交一段HTML代码，所以找了一个HTML页面，临时下载一个也是很方便的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget http://china.alibaba.com/ -O fixture.html
</span></code></pre></td></tr></table></div></figure>


<p>第二步是把这个素材变成ab需要的方式，一是做URL编码，二是写成表单的形式。</p>

<p>我写了一个ruby脚本来做编码的工作:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;uri&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">str</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;fixture.html&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">output</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">str</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\\n|\\r/m</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;post.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
</span><span class='line'>  <span class="n">file</span> <span class="o">&lt;&lt;</span> <span class="sx">%Q(data=</span><span class="si">#{</span><span class="n">output</span><span class="si">}</span><span class="sx">&amp;type=html)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样就在当前目录下生成了一个post.txt文件，格式是</p>

<pre><code>data=&lt;编码过的HTML代码&gt;&amp;type=html
</code></pre>

<p>这是我的程序需要的数据格式，你可以根据实际需要调整。</p>

<p>然后就用ab命令了，我也写了一个shell脚本，减少反复修改执行的重复劳动：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># 测试目标url</span>
</span><span class='line'><span class="nv">server</span><span class="o">=</span>http://fdlint.mysite.com/
</span><span class='line'><span class="nv">amount</span><span class="o">=</span>5000
</span><span class='line'><span class="nv">samual</span><span class="o">=</span>500
</span><span class='line'>
</span><span class='line'>ab -q <span class="se">\\</span>
</span><span class='line'>   -n <span class="nv">$amount</span> -c <span class="nv">$samual</span> <span class="se">\\</span>
</span><span class='line'>   -p post.txt <span class="se">\\</span>
</span><span class='line'>   -T application/x-www-form-urlencoded <span class="se">\\</span>
</span><span class='line'>   <span class="nv">$server</span>
</span></code></pre></td></tr></table></div></figure>


<p>运行这个脚本，看到如下输出，表示性能测试完成:</p>

<pre><code>&gt; Benchmarking fdlint.mysite.com (be patient).....done
</code></pre>

<p>实际执行的时候遇到几个问题。首先是&#8221;-T&#8221;参数一定要有，而且一定是这个值才可以。官方文档里面只是说如果用了-p来POST, 一定设置T参数指定content-type.</p>

<h2>经验总结</h2>

<ol>
<li>如上面所说，url如果是站点根目录，一定要以斜杠(&ldquo;/&rdquo;)结尾</li>
<li>使用-p之后一定要设置-T参数</li>
<li><p>如何确定post过去之后，服务器的返回是正常的?</p>

<ol type="a">
<li>可以用ab的<code>-v</code>参数输出详细的日志，例如：<code>ab -v 4 -n 500 -c 5 $url</code></li>
<li>在服务器可以记录日志</li>
</ol>
</li>
</ol>


<h2>参考文档</h2>

<p><a href="http://httpd.apache.org/docs/2.4/programs/ab.html">官方文档链接</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[fdlint: 让前端code review更轻松]]></title>
    <link href="http://q.pnq.cc/blog/2012/02/13/fdlint/"/>
    <updated>2012-02-13T00:00:00+08:00</updated>
    <id>http://q.pnq.cc/blog/2012/02/13/fdlint</id>
    <content type="html"><![CDATA[<p><img src="http://img.china.alibaba.com/img/ibank/2012/462/137/490731264_678162280.jpg" alt="fdlint" style="border:none;" /></p>

<p><a href="https://github.com/qhwa/fdlint">fdlint</a>是<a href="http://bencode.org">bencode</a> 和 我最近做的一个实用项目。她的参考是<a href="http://jslint.com">jslint</a>——一个js代码扫描工具。和<a href="http://jslint.com">jslint</a>不同的是，<a href="https://github.com/qhwa/fdlint">fdlint</a>还可以扫描css和html代码。</p>

<h2>为什么会做<a href="https://github.com/qhwa/fdlint">fdlint</a>？</h2>

<p>Code review是一项重要却比较花时间的工作，根据阿里巴巴中文站前端Code Review Check List，约有80项检查项目，要完整对照着检查是比较花时间的。太花时间导致的结果就是code review的频率不高。</p>

<p>因此，我们开发了<a href="https://github.com/qhwa/fdlint">fdlint</a>，对HTML/CSS/JS代码进行分析，找出工具能判断的、不符合规范的代码。<a href="https://github.com/qhwa/fdlint">fdlint</a>可以节约我们的时间，帮助 code review 更频繁、更深入。</p>

<h2>特点：</h2>

<ol>
<li>能扫描出不符合规则的常见问题，共49项, 详见<a href="https://github.com/qhwa/fdlint/wiki/fdlint-%E6%89%AB%E6%8F%8F%E8%A7%84%E5%88%99">扫描规则</a></li>
<li>提供多种使用方式，适合不同的应用场景 （命令行、<a href="http://fdlint.herokuapp.com">web</a>、<a href="https://github.com/qhwa/fdlint-vim">VIM插件</a>、<a href="https://github.com/ThinkBest/fdlint-notepad-plusplus">Notepad++插件</a>、Eclipse插件）</li>
<li>规则定制方便，将用DSL编写的规则放入一个目录，立刻生效。</li>
<li>可以批量扫描多个文件，支持递归扫描目录</li>
<li>支持多种输出格式</li>
</ol>


<h2>截图</h2>

<ul>
<li><p>命令行运行</p>

<p>  <img src="http://q.pnq.cc/wp-content/uploads/2012/02/fdlint-cli-500x619.png" alt="" title="fdlint-cli" width="500" height="619" class="alignnone size-medium wp-image-607" /></p></li>
<li><p>web版本</p>

<p>  <img src="http://q.pnq.cc/wp-content/uploads/2012/02/fdlint-host-500x512.png" alt="" title="fdlint-host" width="500" height="512" class="alignnone size-medium wp-image-609" /></p></li>
<li><p>Eclipse插件</p>

<p>  <img src="http://q.pnq.cc/wp-content/uploads/2012/02/fdlint-eclipse-500x140.png" alt="" title="fdlint-eclipse" width="500" height="140" class="alignnone size-medium wp-image-608" /></p></li>
<li><p>Notepad++插件</p>

<p>  <img src="http://q.pnq.cc/wp-content/uploads/2012/02/fdlint-notepad-500x414.png" alt="" title="fdlint-notepad" width="500" height="414" class="alignnone size-medium wp-image-610" /></p></li>
<li><p>VIM插件</p>

<p>  <img src="http://q.pnq.cc/wp-content/uploads/2012/02/fdlint-vim-500x543.png" alt="" title="fdlint-vim" width="500" height="543" class="alignnone size-medium wp-image-611" /></p></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Say Hello To My New Mate]]></title>
    <link href="http://q.pnq.cc/blog/2012/02/09/say-hello-to-my-new-mate/"/>
    <updated>2012-02-09T00:00:00+08:00</updated>
    <id>http://q.pnq.cc/blog/2012/02/09/say-hello-to-my-new-mate</id>
    <content type="html"><![CDATA[<p>没错，这是我的新伙伴，今天正式开始我的骑行了，2012的一大目标就是锻炼身体！</p>

<p><img src="http://q.pnq.cc/wp-content/uploads/2012/02/DSC_0824-500x752.jpg" alt="bike" />
<img src="http://q.pnq.cc/wp-content/uploads/2012/02/DSC_0823-500x332.jpg" alt="bike" /></p>

<p>今天在网上看中的，下午联系，晚上就提车了，真是爽快！
因为信任骑行的人，我对车主“死魂灵”是完完全全的信任，虽然我还是车盲一个，哈哈！
提车的时候，死魂灵无微不至的交代，各种经验之谈浓缩在短短的十分钟之内，从车的调节，到刹车的时候，还有分别时候的关于安全的交代。。我囫囵吞枣般地都短暂记住了，那个场景让我想起了小说里的场面：一个武功高手在传内力给一个战斗力只有5的小朋友。。</p>
]]></content>
  </entry>
  
</feed>
