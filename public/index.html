
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>qhwa's blog</title>
	<meta name="author" content="qhwa">

	
	<meta name="description" content="源码地址：https://github.com/elixir-lang/ex_doc
ex_doc 是 elixir 代码生成文档的工具。 生成文档的方式有很多种： 利用语法解析分析源码；
利用语言提供的反射能力分析； Elixir 提供的反射功能非常全面，利用 Code 模块提供的一些方法， &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="qhwa's blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">qhwa's blog</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:q.pnq.cc">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
		<a class="github" href="https://github.com/qhwa" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:q.pnq.cc">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2017/01/28/ex-doc/">
		
			Elixir 源码阅读笔记: Ex_doc</a>
	</h2>
	<div class="entry-content">
		<p>源码地址：<a href="https://github.com/elixir-lang/ex_doc">https://github.com/elixir-lang/ex_doc</a>
ex_doc 是 elixir 代码生成文档的工具。</p>

<p>生成文档的方式有很多种：</p>

<ol>
<li>利用语法解析分析源码；</li>
<li>利用语言提供的反射能力分析；</li>
</ol>


<p>Elixir 提供的反射功能非常全面，利用 Code 模块提供的一些方法，可以获得目标模块的很多信息。</p>

<p>文档也是其中一种。例如我们有这样的一个模块：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="k">defmodule</span> <span class="no">Example</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'><span class="k">  </span><span class="nv">@moduledoc</span> <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">  Example module for `ex_doc`.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">  ## Examples</span>
</span><span class='line'>
</span><span class='line'><span class="sd">  ``\`</span>
</span><span class='line'><span class="sd">  iex&gt; Example.hello</span>
</span><span class='line'><span class="sd">  :world</span>
</span><span class='line'><span class="sd">  ``\`</span>
</span><span class='line'><span class="sd">  &quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">@doc</span> <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">  hello world!</span>
</span><span class='line'><span class="sd">  &quot;&quot;&quot;</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">hello</span> <span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="ss">:world</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们可以通过 <code>Code.get_docs/2</code> 获得模块的文档。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Code</span><span class="o">.</span><span class="n">get_docs</span> <span class="no">Example</span><span class="p">,</span> <span class="ss">:all</span>
</span><span class='line'><span class="p">[</span><span class="ss">docs:</span> <span class="p">[{</span> <span class="p">{</span><span class="ss">:hello</span><span class="p">,</span> <span class="m">0</span><span class="p">},</span> <span class="m">14</span><span class="p">,</span> <span class="ss">:def</span><span class="p">,</span> <span class="p">[],</span> <span class="s2">&quot;hello world!\n&quot;</span><span class="p">}],</span>
</span><span class='line'> <span class="ss">moduledoc:</span> <span class="p">{</span><span class="m">3</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;Example module for `ex_doc`.\n\n</span><span class="err">##</span><span class="s2"> Examples\n\n```\niex&gt; Example.hello\n:world\n```\n&quot;</span><span class="p">},</span>
</span><span class='line'> <span class="ss">callback_docs:</span> <span class="p">[],</span> <span class="ss">type_docs:</span> <span class="p">[]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到，Elixir 已经在模块的信息中保存了相关的文档信息。ExDoc 接下来做的是提取出来，并进行格式转换。其中用到非常多的反射的接口，大部分都在 <code>Code</code> 模块中提供了。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2017-01-28T10:03:00+08:00" pubdate data-updated="true">Jan 28<span>th</span>, 2017</time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2017/01/17/daily-reading-1/">
		
			Daily Reading Note #1</a>
	</h2>
	<div class="entry-content">
		<p>这里记录了每天阅读代码记录的新知识。</p>

<h3>List.keymember?/3</h3>

<p>用来检查 Keyword List 中有没有对应的 key / value：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">List</span><span class="o">.</span><span class="n">keymember?</span><span class="p">([</span><span class="ss">a:</span> <span class="m">1</span><span class="p">,</span> <span class="ss">b:</span> <span class="m">2</span><span class="p">],</span> <span class="ss">:a</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'><span class="no">true</span>
</span><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">List</span><span class="o">.</span><span class="n">keymember?</span><span class="p">([</span><span class="ss">a:</span> <span class="m">1</span><span class="p">,</span> <span class="ss">b:</span> <span class="m">2</span><span class="p">],</span> <span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
</span><span class='line'><span class="no">true</span>
</span><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">List</span><span class="o">.</span><span class="n">keymember?</span><span class="p">([</span><span class="ss">a:</span> <span class="m">1</span><span class="p">,</span> <span class="ss">b:</span> <span class="m">2</span><span class="p">],</span> <span class="ss">:c</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'><span class="no">false</span>
</span></code></pre></td></tr></table></div></figure>


<h3>:code.where_is_file/1</h3>

<p>可以从 load_paths 中找到 beam 文件</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="ss">:code</span><span class="o">.</span><span class="n">where_is_file</span><span class="p">(</span><span class="s1">&#39;Elixir.Kernel.beam&#39;</span><span class="p">)</span>
</span><span class='line'><span class="s1">&#39;/usr/local/bin/../lib/elixir/ebin/Elixir.Kernel.beam&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Code.prepend_path/1</h3>

<p>将一个路径加入 Elixir 的 load_paths</p>

<h3>Code.eval_string/3</h3>

<p>执行一段代码，并返回结果，以及结果 binding</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Code</span><span class="o">.</span><span class="n">eval_string</span> <span class="s2">&quot;b = a + 1&quot;</span><span class="p">,</span> <span class="p">[</span><span class="ss">a:</span> <span class="m">1</span><span class="p">],</span> <span class="ss">file:</span> <span class="n">__ENV__</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="ss">line:</span> <span class="n">__ENV__</span><span class="o">.</span><span class="n">line</span>
</span><span class='line'><span class="p">{</span><span class="m">2</span><span class="p">,</span> <span class="p">[</span><span class="ss">a:</span> <span class="m">1</span><span class="p">,</span> <span class="ss">b:</span> <span class="m">2</span><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Keyword.get_values/2</h3>

<p>获取关键字列表中某个 key 对应的所有值，很适合用来获取参数</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Keyword</span><span class="o">.</span><span class="n">get_values</span> <span class="p">[</span><span class="ss">path:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">path:</span> <span class="s2">&quot;b/c&quot;</span><span class="p">],</span> <span class="ss">:path</span>
</span><span class='line'><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b/c&quot;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>:binary.last/1<code>或</code>String.last/1</h3>

<p>获取字符串的最后一个字符</p>

<h3>Kernel.struct/2</h3>

<p>适合留下 struct 合法的 key，丢弃不合法的 key</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="k">defmodule</span> <span class="no">User</span> <span class="k">do</span>
</span><span class='line'><span class="o">...&gt;</span>  <span class="n">defstruct</span> <span class="ss">name:</span> <span class="no">nil</span>
</span><span class='line'><span class="o">...&gt;</span> <span class="k">end</span>
</span><span class='line'><span class="o">...&gt;</span> <span class="n">struct</span> <span class="err">%</span><span class="no">User</span><span class="p">{</span><span class="ss">name:</span> <span class="s2">&quot;qhwa&quot;</span><span class="p">},</span> <span class="err">%</span><span class="p">{</span><span class="ss">name:</span> <span class="s2">&quot;Billy&quot;</span><span class="p">,</span> <span class="ss">age:</span> <span class="m">10</span><span class="p">}</span>
</span><span class='line'><span class="err">%</span><span class="no">User</span><span class="p">{</span><span class="ss">name:</span> <span class="s2">&quot;Billy&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Code.ensure_loaded?/1</h3>

<p>可以判断一个 Module 是否已经加载进来了</p>

<h3>Path.wildcard/1</h3>

<p>等于 Ruby 的 <code>Dir.glob</code></p>

<h3>Path.basename/2</h3>

<p>和 Ruby 一样，可以用来去掉扩展名</p>

<h3>Kernel.function_exported?/3</h3>

<p>判断一个模块是否暴露了方法名</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="n">function_exported?</span> <span class="no">Kernel</span><span class="p">,</span> <span class="ss">:struct</span><span class="p">,</span> <span class="m">2</span>
</span><span class='line'><span class="no">true</span>
</span></code></pre></td></tr></table></div></figure>


<h3><code>Code.get_docs/2</code></h3>

<p>如果编译时有 <code>--docs</code> 选项（默认是有的），可以从模块中得到文档。返回 <code>{line, text}</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Code</span><span class="o">.</span><span class="n">get_docs</span> <span class="no">Code</span><span class="p">,</span> <span class="ss">:moduledoc</span>
</span><span class='line'><span class="p">{</span><span class="m">2</span><span class="p">,</span>
</span><span class='line'> <span class="s2">&quot;Utilities for managing code compilation, code evaluation and code loading.\n\nThis module complements Erlang&#39;s [`:code` module](http://www.erlang.org/doc/man/code.html)\nto add behaviour which is specific to Elixir. Almost all of the functions in this module\nhave global side effects on the behaviour of Elixir.\n&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Enum.at/1</h3>

<h3>module.<strong>info</strong>(:compile)</h3>

<p>能获取一些编译信息</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Code</span><span class="o">.</span><span class="n">__info__</span><span class="p">(</span><span class="ss">:compile</span><span class="p">)</span>
</span><span class='line'><span class="p">[</span><span class="ss">options:</span> <span class="p">[</span><span class="ss">:debug_info</span><span class="p">],</span> <span class="ss">version:</span> <span class="s1">&#39;6.0.1&#39;</span><span class="p">,</span> <span class="ss">time:</span> <span class="p">{</span><span class="m">2017</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">33</span><span class="p">,</span> <span class="m">52</span><span class="p">},</span>
</span><span class='line'> <span class="ss">source:</span> <span class="s1">&#39;/Users/jose/OSS/elixir/lib/elixir/lib/code.ex&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Kernel.Typespec.beam_specs/1</h3>

<p>可以获取一个模块的类型信息</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Kernel</span><span class="o">.</span><span class="no">Typespec</span><span class="o">.</span><span class="n">beam_specs</span><span class="p">(</span><span class="no">Code</span><span class="p">)</span>
</span><span class='line'> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<h3>如何在管道中用 <code>||</code></h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">a</span> <span class="o">|&gt;</span> <span class="n">func</span><span class="p">()</span> <span class="o">|&gt;</span> <span class="no">Kernel</span><span class="o">.||</span><span class="p">([])</span> <span class="o">|&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">inspect</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2017-01-17T23:16:40+08:00" pubdate data-updated="true">Jan 17<span>th</span>, 2017</time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2016/09/17/mooncake/">
		
			也谈谈月饼事件</a>
	</h2>
	<div class="entry-content">
		<p><img src="http://www.zaobao.com.sg/sites/default/files/styles/article_large_full/public/images/201609/20160914/809.jpg?itok=vyZLXFnr&amp;timestamp=1473817356" alt="mooncake" /></p>

<p>中秋前夕，阿里的月饼事件引爆了圈内网络（<a href="https://www.zhihu.com/question/50600301">事件回顾</a>）。事情从当事人双方的角度来说都有道理：</p>

<ul>
<li>程序员：只是利用技术替代人工抢，和正常点击按钮抢并没有差别。没想到服务器端有程序 bug，可以不停抢。发现问题后没有付款，赶快联系了行政要退还。</li>
<li>HR: 5个人抢了120多盒月饼，过分了。安全部门的职责就是防范「黑灰产」的，怎么能「监守自盗」！(淘宝上有阿里的中秋月饼在售卖）</li>
</ul>


<p>我相信阿里有自己的立场和原则，不会为外界质疑所动，甚至他们 4 小时的复盘结果也是毫无愧谦之意。也有人颇为赞同这种「捍卫价值观」的做法。</p>

<p>但阿里在程序员的心目中一落千丈已经是不争的事实，外界技术人员对阿里的看法更清醒了，阿里不是一家技术驱动的公司，这里没有工程师文化的土壤。甚至连内部的程序员也对事件非常失望。在我印象里，上市之后，阿里对技术「开源」的态度急转而下。阿里已经成为一个竭尽全力避免风险的公司。这无可厚非，几乎没有一家公司像阿里这样拥有巨大的成功而又充满争议。</p>

<p><img src="/images/toy.jpg" alt="toy" /></p>

<p>然而懂点程序的人都能看得出问题所在。</p>

<ul>
<li>假设这5个人，每人只抢了一盒月饼，从性质上来说，还是不是一样的？显然不是，因为明显可以排除拿去售卖 的可能。但从阿里的官方说辞里面，显然是一样的性质：「技术压制」造成不公平，以及利用系统漏洞获利。那这种情况，是不是也开除？</li>
<li><p>对比一下以下情况，你觉得性质上是否有差别：</p>

<ul>
<li>抢到 100 盒月饼，每盒都付款；</li>
<li>抢到 100 盒月饼，每盒都付款，然后进行高价售卖；</li>
<li>抢到 100 盒月饼，但是只买 1 盒，其余的主动退掉。</li>
</ul>
</li>
</ul>


<p>我再举一个真实的发生在我身上的案例。有一次，妹纸和她的小伙伴们想要去一个博物馆看一个很不错的展览，这个展览在她们的行业里是很火爆的，需要在博物馆的网站上抢票，虽然票是免费发放的，但是只能在一个时间后才开放。她们担心到时候人多抢不到票，于是让我帮忙看看。我试了一下，发现时间限制只是在网页前端做的，完全可以绕开。就用几条命令帮她们提前申请到票了。我没有觉得有愧于心，因为：</p>

<ul>
<li>我有机会领到更多的票，高价出售给别人，但我没有；</li>
<li>我可以炫耀给别人，让博物馆因为这个漏洞遭受损失，但我没有；</li>
</ul>


<p>可见，我是有机会成为所谓的「黑灰产」的，但我没有。<strong>如果因为我将来可能会犯错，而将我提前关起来，这个逻辑是不合理的。</strong></p>

<p>以我 7 年多阿里生涯来看，真没看出来抢月饼是不符合哪条价值观了。以未曾发生的事情（安全部成了自我黑灰产）为处理依据，臆断别人的用意；为了达到杀鸡儆猴的效果，做出令人啼笑皆非的处理。这件事情拿不出哪条条例，连价值观的说法也难以服众。还说不是处罚太重？这恐怕是本年度程序员最被误解的事情了吧？</p>

<p>从阿里离职以来，本着价值观「随时随地维护公司形象」，我从未说过阿里什么坏话，但这件事情让我太看不下去了，看不下去程序员被如此误解，如此对待。</p>

<p>只想表达一个观点：这件事情的处理是不懂程序员的阿里管理层犯下的一个错误，但会有什么影响，历史会告诉我们。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2016-09-17T12:50:44+08:00" pubdate data-updated="true">Sep 17<span>th</span>, 2016</time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2016/05/05/minifying-with-webpack/">
		
			Minifying-with-webpack</a>
	</h2>
	<div class="entry-content">
		<p><img src="https://cdn-images-1.medium.com/max/1600/1*rsOjd1jR3eOmJNJh4Zp42g.png" alt="webpack bundling" /></p>

<p>When coding in a modern modular way with Webpack is done, it enters the deploy phrase. We minify assets to reduce the network transfer cost. While bundling is not necessary nowadays thanks to HTTP/2, minifying is still an important work, because in many cases we can reduce the size to transfer between servers and clients:</p>

<ul>
<li>unreachable codes can be removed</li>
<li>comments code can be removed</li>
<li>images can be optimised losslessly</li>
<li>variable names can be shortened in Javascript</li>
<li>HTML and SVGs can be optimised</li>
</ul>


<p>Here in <a href="http://www.helijia.com">Helijia</a>, we use webpack to build mobile apps. Here are some notes from us on minifying with <a href="https://webpack.github.io">Webpack</a>.</p>

<h2>Minifying Javascript / CSS</h2>

<p><a href="https://webpack.github.io">Webpack</a> is shipped with some builtin plugins which can do the job well.
* <a href="https://webpack.github.io/docs/list-of-plugins.html#dedupeplugin">Dedupe Plugin</a> searches for similar files and deduplicated them in the output.
* <a href="https://webpack.github.io/docs/list-of-plugins.html#uglifyjsplugin">UglyfiJS Plugin</a> uses the famous <a href="https://github.com/mishoo/UglifyJS">UglifyJS</a> to minify JS and CSS assets.</p>

<h3>Tip: Use webpack stats to review your modules</h3>

<p>Webpack can generate packing stats in json format while packing. We use <a href="https://chrisbateman.github.io/webpack-visualizer/">Webpack visualizer</a> to visualize it to find which part of our works can be optimized. It helps a lot by providing an detail view inside the bundled file.</p>

<p><img src="https://cdn-images-1.medium.com/max/1600/1*fNQylMzJclEm5VDbVuHwVQ.png" alt="webpack viz" /></p>

<h2>Minifying HTML</h2>

<p><a href="https://github.com/ampedandwired/html-webpack-plugin">HTML webpack plugin</a> can help minifying HTML. Here is an example config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">new</span> <span class="nx">HtmlWebpackPlugin</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">template</span> <span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;../src/template.html.ejs&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">filename</span> <span class="o">:</span> <span class="s1">&#39;index.html&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">title</span>    <span class="o">:</span> <span class="s1">&#39;河狸家&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">inject</span>   <span class="o">:</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">minify</span>   <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">html5</span>                          <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">collapseWhitespace</span>             <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">minifyCSS</span>                      <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">minifyJS</span>                       <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">minifyURLs</span>                     <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">removeAttributeQuotes</span>          <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">removeComments</span>                 <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">removeEmptyAttributes</span>          <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">removeOptionalTags</span>             <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">removeRedundantAttributes</span>      <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">removeScriptTypeAttributes</span>     <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">removeStyleLinkTypeAttributese</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">useShortDoctype</span>                <span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}),</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Minifying SVG</h2>

<p>we are currently using <a href="https://github.com/rpominov/svgo-loader">svgo-loader</a> to keep SVGs clean.</p>

<p>before:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; standalone=&quot;no&quot;?&gt;</span>
</span><span class='line'><span class="cp">&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot; &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;</span>
</span><span class='line'><span class="nt">&lt;svg</span> <span class="na">width=</span><span class="s">&quot;100%&quot;</span> <span class="na">height=</span><span class="s">&quot;100%&quot;</span> <span class="na">viewBox=</span><span class="s">&quot;0 0 10 18&quot;</span> <span class="na">version=</span><span class="s">&quot;1.1&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="na">xmlns:xlink=</span><span class="s">&quot;http://www.w3.org/1999/xlink&quot;</span> <span class="na">xml:space=</span><span class="s">&quot;preserve&quot;</span> <span class="na">style=</span><span class="s">&quot;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;path</span> <span class="na">id=</span><span class="s">&quot;Shape-Copy&quot;</span> <span class="na">d=</span><span class="s">&quot;M9.157,0.136L0.157,8.636C-0.052,8.834 -0.052,9.166 0.157,9.364L9.157,17.864C9.357,18.053 9.674,18.044 9.864,17.843C10.053,17.643 10.044,17.326 9.843,17.136L1.222,8.994L9.843,0.864C10.044,0.674 10.053,0.357 9.864,0.157C9.674,-0.044 9.357,-0.053 9.157,0.136Z&quot;</span> <span class="na">style=</span><span class="s">&quot;fill:rgb(189,157,98);&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/svg&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>after:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;svg</span> <span class="na">class=</span><span class="s">&quot;SVGInline-svg icon-svg&quot;</span> <span class="na">style=</span><span class="s">&quot;width: 1em;height: 1em;&quot;</span> <span class="na">viewBox=</span><span class="s">&quot;0 0 10 18&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="na">fill-rule=</span><span class="s">&quot;evenodd&quot;</span> <span class="na">clip-rule=</span><span class="s">&quot;evenodd&quot;</span> <span class="na">stroke-linejoin=</span><span class="s">&quot;round&quot;</span> <span class="na">stroke-miterlimit=</span><span class="s">&quot;1.414&quot;</span><span class="nt">&gt;&lt;path</span> <span class="na">d=</span><span class="s">&quot;M9.157.136l-9 8.5a.5.5 0 0 0 0 .728l9 8.5a.5.5 0 0 0 .686-.728l-8.62-8.142 8.62-8.13a.5.5 0 0 0-.686-.728z&quot;</span> <span class="na">fill=</span><span class="s">&quot;#bd9d62&quot;</span><span class="nt">&gt;&lt;/path&gt;&lt;/svg&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Minifying bitmap Images</h2>

<p><a href="https://github.com/tcoopman/image-webpack-loader">Image-webpack-loader</a> can save a lot bandwidth.</p>

<h2>Conclusion</h2>

<p>Webpack provides a powerful way of web developing, we use some plugins to automating the deployment. and there are more out of our view. So let&rsquo;s keep exploring and make web development more enjoyable.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2016-05-05T10:09:12+08:00" pubdate data-updated="true">May 5<span>th</span>, 2016</time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2016/05/02/shi-yong-yeomankuai-su-da-jian-reactkai-fa-huan-jing/">
		
			Setting Up Your React Project Is Easier Than You Think</a>
	</h2>
	<div class="entry-content">
		<p>I have heard some ones complaining that setting up a <a href="https://webpack.github.io/">Webpack</a> + <a href="https://facebook">React</a> project is not an easy job. It&rsquo;s only partly true. <a href="https://webpack.github.io/">Webpack</a> is not well documented at this moment, and has many powerful features and plugins. This makes configuration on <a href="https://webpack.github.io/">Webpack</a> seem difficult to new developers. To make things even worse, there are tons of &lsquo;starter kit&rsquo; projects over there, most of which are lack of maintainance.</p>

<p><img src="http://yeoman.io/static/yeoman-02.83c46c7213.png" alt="Yeoman" /></p>

<p>Indeed, it is super easy to setup a brand new <a href="https://webpack.github.io/">Webpack</a> + <a href="https://facebook">React</a> project using <a href="http://yeoman.io/">Yeoman</a>.</p>

<p><a href="http://yeoman.io/">Yeoman</a> is a scaffolding tool for web developers. With diffrent <code>generators</code> we can generate different kinds of web projects quickly by lines of command.</p>

<p>Here&rsquo;s how it is done:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># install Yeoman command and generator</span>
</span><span class='line'>npm install -g yo
</span><span class='line'>npm install -g generator-react-webpack
</span><span class='line'>
</span><span class='line'><span class="c"># generate project</span>
</span><span class='line'>mkdir <span class="nb">test</span>-project
</span><span class='line'><span class="nb">cd test</span>-project
</span><span class='line'>yo react-webpack
</span></code></pre></td></tr></table></div></figure>


<p>Thanks to <a href="https://github.com/newtriks/generator-react-webpack">generator-react-webpack</a>, after answering some questions from <code>yo</code> you will get your project setup in seconds.</p>

<p>Easy and quick, right? Here&rsquo;s what we have got out of the box:</p>

<ul>
<li>a project with Webpack and React configured;</li>
<li>a solution for diffrent environments both for runtime and webpack configuration;</li>
<li>a <a href="https://facebook.github.io/flux/">flux</a> project structure;</li>
<li>an optional <a href="http://postcss.org/">PostCSS</a> setup</li>
</ul>


<p>Also this generator can help <a href="https://github.com/newtriks/generator-react-webpack#generating-new-components">generate React components</a> via command line.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2016-05-02T22:16:08+08:00" pubdate data-updated="true">May 2<span>nd</span>, 2016</time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2016/05/02/why-not-write-any-more/">
		
			为什么写不出博客了</a>
	</h2>
	<div class="entry-content">
		<p>近几年以来，我写博客的数量每况愈下，从几个月一篇，到几个季度一篇，现在已经将近一年一篇了。。 (✖╭╮✖)</p>

<p>今天也是无意间提起，让我思考这个问题</p>

<h2>为什么越来越不写博客了呢？</h2>

<ol>
<li><p>首先想到的是「懒」+「忙」</p>

<p> 但其实「没时间」是一个最不成立的理由，所谓的「没时间」往往是「优先级不高」的幌子罢了。很多时候不忙，心里知道有很多事情应该去做，却什么也不想做。<a href="http://baike.baidu.com/subview/26649/19131821.htm?fromtitle=%E7%8E%8B%E9%98%B3%E6%98%8E&amp;fromid=5710&amp;type=syn">阳明先生</a> 说没有「知易行难」这件事，不「行」是由于「知」得还不彻底。是的，我没有在自己心里把写博客重视起来当一回事，当成一定<strong>非完成不可的</strong>的事情。</p></li>
<li><p>追求的事物已发生了转移?</p>

<p> 是以前对技术更感兴趣一些，现在不感兴趣了吗？似乎也不是，现在每天起来之后也会阅读技术文章。对技术反而比以前更执着了。</p></li>
<li><p>害怕写不好</p>

<p> 以前反而大胆一些，也不怕误导别人；现在反而一些就想写很多，想写一个系列，系统地传授一系列的知识，系统地引导别人掌握一个东西。想做的事情太大，又没有足够的精力去做，于是就这样了。</p></li>
</ol>


<p>原因算是找到了。</p>

<h2>Done better than perfect</h2>

<p>写得差总比不写要好，其实我的 blog 访问量那么低，也误导不了几个人。何况我最近也想明白了，没有所谓的「误导」，每个人都需要有自己的判断力，看到别人的论点需要有甄别的能力。阅读是自己的权利，判断也是自己的义务。坚持推荐我认为「好」的事物，就算因此让别人走了弯路，相信这种弯路也会是一种积累的。</p>

<p>所以我决定，从这篇开始，要多写写一些短小的技术文章了。即便没有人看也没关系，回归当初写 blog 的心境，记录自己的成长。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2016-05-02T21:41:39+08:00" pubdate data-updated="true">May 2<span>nd</span>, 2016</time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/08/09/why-the-limits-config-not-hornored/">
		
			为什么 Limits 不生效</a>
	</h2>
	<div class="entry-content">
		<p>最近遇到一个奇怪的问题，无法将服务器的最大文件打开数量提高。</p>

<p>服务器是 Ubuntu Server 14.04</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$lsb_release</span> -a
</span><span class='line'>No LSB modules are available.
</span><span class='line'>Distributor ID:   Ubuntu
</span><span class='line'>Description:  Ubuntu 14.04.2 LTS
</span><span class='line'>Release:  14.04
</span><span class='line'>Codename: trusty
</span></code></pre></td></tr></table></div></figure>


<p>正常情况下， <code>/etc/security/limits.conf</code> 的改动，应该在下次访问时就生效才对。
但是总是没生效，查了很多资料，尝试了很多修改，终于成功了</p>

<h2>记录一下填的坑：</h2>

<h3>1. 确保 pam 生效</h3>

<p>在 <code>/etc/pam.d/login</code> 中，存在:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>session required pam_limits.so
</span></code></pre></td></tr></table></div></figure>


<h3>2. 确保 ssh 使用 pam</h3>

<p>在 <code>/etc/pam.d/sshd</code> 中，存在:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>session required pam_limits.so
</span></code></pre></td></tr></table></div></figure>


<p>在 <code>/etc/ssh/ssd_config</code> 中, 存在:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>UsePAM yes
</span></code></pre></td></tr></table></div></figure>


<h3>3. limits.conf 建议不要使用星号</h3>

<p>官方 manual 以及网上的教程有很多都用了 <code>*</code> 符号，然而不是所有系统都认的，我最后发现问题就是在这里！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># 不兼容方式:</span>
</span><span class='line'>* soft nofile 51200
</span><span class='line'>* hard nofild 51200
</span><span class='line'>
</span><span class='line'><span class="c"># 兼容方式</span>
</span><span class='line'>root soft nofile 51200
</span><span class='line'>root hard nofile 51200
</span><span class='line'>
</span><span class='line'>qhwa soft nofile 51200
</span><span class='line'>qhwa hard nofile 51200
</span></code></pre></td></tr></table></div></figure>


<h2>如何确认问题之所在</h2>

<h3>查看当前用户的 limits</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">ulimit</span> -a
</span></code></pre></td></tr></table></div></figure>


<h3>查看另外一个用户的 limits</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># 注意 ulimit 不是命令，而是 shell 方法</span>
</span><span class='line'>sudo -u &lt;USER&gt; sh -c <span class="s1">&#39;ulimit -a&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>经过 ssh 查看用户的 limits</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>ssh example.com <span class="s1">&#39;ulimit -a&#39;</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-08-09T21:14:35+08:00" pubdate data-updated="true">Aug 9<span>th</span>, 2015</time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/02/11/capistrano-deloy-only-to-selected-servers/">
		
			Capistrano-hostmenu: 只操作指定的服务器</a>
	</h2>
	<div class="entry-content">
		<p>想必大家都用过 <a href="http://capistranorb.com/">capistrano</a> 了，部署代码到多个服务器上的神器。
不过使用中有个不太方便的地方是，某些情况下只想部署到其中几台。</p>

<p>例如我们新增了一个功能，但只想找一台服务器先部署上去测试一下，成功后再部署到整个集群。</p>

<p>有好几种方式可以做到：</p>

<ol>
<li>临时修改发布脚本（<code>config/deploy.rb</code> 或 <code>config/deploy/***.rb</code>）</li>
<li>使用 <code>HOST</code> 命令行环境变量，或者 <code>--host</code> 参数, 比如 <code>HOST=example.com cap production deploy</code></li>
</ol>


<p>第1种不好重用，第2种在 <a href="http://capistranorb.com/">capistrano</a> v3.3 以上版本已经失效了。</p>

<p>我把我们项目中用的 task 抽出来做成了一个 gem: <a href="https://github.com/qhwa/capistrano-hostmenu">capistrano-hostmenu</a>
功能实在是太简单，没有什么好描述的。。</p>

<p>一图顶千言：</p>

<p><img src="https://ruby-china-files.b0.upaiyun.com/photo/2015/fd0dc13527ea01a9c5461ddc2b37638a.png" alt="" /></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-02-11T22:10:44+08:00" pubdate data-updated="true">Feb 11<span>th</span>, 2015</time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/11/16/a-little-project-for-download-huaban-pins/">
		
			如何开发 Ruby 命令行工具</a>
	</h2>
	<div class="entry-content">
		<p>最近 @季子乌 的 <a href="http://huaban.com/pigeonzhu">花瓣账号</a> 突然被封，苦心采集的很多图片一下子全部看不到了！</p>

<p>后来虽然联系客服重新开通了账号，但还是心有余悸，觉得还是 <a href="http://www.pinterest.com/">pinterest</a> 靠谱一些，准备把图片全部迁移到 pinterest 上。由于图片数量比较多，我就用 ruby 写了一个工具，将花瓣上的图片下载下来。（不过 pinterest 不能批量上传，这些图片也只是备份到本地，这是后话了）</p>

<p>这个项目已开源，地址是：
<a href="https://github.com/qhwa/huaban_exporter">https://github.com/qhwa/huaban_exporter</a></p>

<p>这个工具下载后，可以用执行 <code>huaban</code> 命令</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>huaban <span class="nb">export </span>boards --of qhwa
</span></code></pre></td></tr></table></div></figure>


<p>执行效果：</p>

<p><img src="https://xiaotuhe.com/uploads/share/file/58904c1c21892b12963cca37291e6547.gif" alt="preview" /></p>

<p>我喜欢用命令行工作，之前做的几个 gem（<a href="https://github.com/qhwa/lfd">lfd</a>, <a href="https://github.com/qhwa/fdlint">fdlint</a>）也都提供了命令行。这次就趁这个项目总结了一下怎样用 ruby 开发友好的命令行工具。</p>

<h3>I. 初期怎样提高开发效率？</h3>

<p>在写了基础的一些逻辑 model 后，我写个简单的 <a href="https://github.com/qhwa/huaban_exporter/blob/69b16009357a87f2e6e645801694a16b65803a41/Rakefile">rake 文件</a>，初期用 rake 来作为入口，边开发边测试。</p>

<p>一开始我只建了这样的一个 rake 任务，来调试获取画板列表功能：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rake boards         <span class="c"># 列出一个用户的所有画板 (user=用户名 rake boards)</span>
</span></code></pre></td></tr></table></div></figure>


<p>后来随着功能不断完成，逐渐增加了几个新的任务，最后是完整的任务：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rake boards         <span class="c"># 列出一个用户的所有画板 (user=用户名 rake boards)</span>
</span><span class='line'>rake export_board   <span class="c"># 导出一个画板的所有图片到本地 (board_id=画板id  rake export_board)</span>
</span><span class='line'>rake export_boards  <span class="c"># 导出用户所有的画板图片到本地 (user=用户名 rake export_boards)</span>
</span><span class='line'>rake pins           <span class="c"># 列出一个画板所有的采集 (board_id=画板id rake pins)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>II. 项目后期功能稳定后，怎么做命令行入口</h3>

<p>rakefile 很适合自己用，但是要分发别人用，用 rakefile 就不方便了。做成带命令行脚本的 gem 更加方便。</p>

<ul>
<li>把你的脚本放到 <code>bin</code> 目录下</li>
<li>加上执行权限(<code>chmod a+x</code>)</li>
<li>加上 <a href="http://zh.wikipedia.org/zh-cn/Shebang">shebang</a>, 比如 <code>#!/usr/bin/env ruby</code></li>
</ul>


<blockquote><p>这一步我以前是用下面提到的 gli 来自动进行，但后来改成手动做了。因为 gli 生成了一些额外的文件，和 bundle 有点冲突。</p></blockquote>

<h3>III. 怎样让命令变得友好?</h3>

<p>有个超棒的 gem 叫做 <a href="https://github.com/davetron5000/gli">gli</a>，帮你很容易实现出类似 git 这样风格的脚本</p>

<h3>IV. 项目完成后，怎么用做成一个 gem，分享给别人?</h3>

<p><a href="http://bundler.io/">bundler</a> 提供了生成 gem 的功能</p>

<ol>
<li><code>bundle gem &lt;name&gt;</code> 生成目录结构</li>
<li>修改 gemspec</li>
<li><code>rake install</code> 先在本地安装这个 gem 进行测试</li>
<li><code>rake build</code>   以最新的文件重新打包成 gem</li>
<li><code>gem push pkg/&lt;版本&gt;.gem</code> 将gem上传到 <a href="https://rubygems.org">https://rubygems.org</a></li>
</ol>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-11-16T15:54:01+08:00" pubdate data-updated="true">Nov 16<span>th</span>, 2014</time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/10/13/ssl-notes-with-rails/">
		
			SSL Notes With Ruby on Rails</a>
	</h2>
	<div class="entry-content">
		<p>上周我给<a href="https://xiaotuhe.com">小兔盒</a>加上了https，比想象中容易许多。记录一下</p>

<h3>免费的CA:</h3>

<p>之前一直以为 CA 是需要每年付一笔不菲的费用的，但其实也有免费的，例如：</p>

<ul>
<li><a href="https://buy.wosign.com/free/">https://buy.wosign.com/free/</a> (推荐)</li>
<li><a href="https://www.startssl.com/">https://www.startssl.com/</a></li>
</ul>


<p>按照网站指示，可以获得由其颁发的证书 有两个文件(certification &amp; key) 是后面工作的基础。</p>

<h3>在开发环境中使用 https (无需nginx)</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>thin start --ssl --ssl-key-file YOUR_SSL_KEY_FILE --ssl-cert-file YOUR_CERT_FILE
</span></code></pre></td></tr></table></div></figure>


<h3>一些 tips</h3>

<h4>url helpers</h4>

<p>不管当前 request 是 https 还是 http，rails 的 url_helper 都使用 http</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># file: config/routes:</span>
</span><span class='line'><span class="n">root</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;home#index&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># in views or helpers:</span>
</span><span class='line'><span class="n">root_url</span>                    <span class="c1">#=&gt; http://YOUR_SITE/</span>
</span><span class='line'><span class="n">root_url</span> <span class="ss">protocol</span><span class="p">:</span> <span class="s1">&#39;https&#39;</span>  <span class="c1">#=&gt; https://YOUR_SITE/</span>
</span></code></pre></td></tr></table></div></figure>


<h4>使用 protocol 无关的 assets 地址</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># file: config/environments/production.rb</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">action_controller</span><span class="o">.</span><span class="n">asset_host</span> <span class="o">=</span> <span class="s1">&#39;//YOUR-CDN.com&#39;</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>用工具检查</h4>

<p>有很多工具可以检查 https 部署情况，例如这个：
<a href="https://www.sslshopper.com/ssl-checker.html">https://www.sslshopper.com/ssl-checker.html</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-10-13T15:54:01+08:00" pubdate data-updated="true">Oct 13<span>th</span>, 2014</time></div>
	<div class="tags">

</div>
	
</div>
</article>

<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2017

    qhwa

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'qhwa';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-49131235-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>